---
title: "Dockerã‚³ãƒ³ãƒ†ãƒŠä¸Šã§golang-migrateã‚’ä½¿ã£ã¦MongoDBã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³"
emoji: "ğŸƒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [mongodb, docker]
published: false
---

# ã¯ã˜ã‚ã«

MongoDB ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€ã©ã†ã™ã‚‹ã®ãŒè‰¯ã„ã‹ãªãƒ¼ã¨æ€ã£ã¦èª¿æŸ»ã—ã¦ã¿ã¾ã—ãŸã€‚
æ¤œç´¢ã—ã¦ã‚‹ã¨ã€Go ã§æ›¸ã‹ã‚ŒãŸ[golang-migrate/migrate](https://github.com/golang-migrate/migrate)ãŒã‚·ãƒ³ãƒ—ãƒ«ã§è‰¯ã•ãã†ã ã£ãŸã®ã§ã€è©¦ã™ã“ã¨ã«ã—ã¾ã—ãŸã€‚
æ°—ã«å…¥ã£ãŸãƒã‚¤ãƒ³ãƒˆã¯ã€ã“ã“ã‚‰ã§ã™ã€‚

1. å¯¾å¿œã—ã¦ã‚‹ DB ãŒå¤šã„ã€‚ï¼ˆPostgreSQL ã«ã‚‚ MongoDB ã«å¯¾å¿œã—ã¦ãŸï¼‰
2. æ©Ÿèƒ½ãŒã‚·ãƒ³ãƒ—ãƒ«ãã†ã€‚
3. æƒ…å ±ã¨ Star ãŒå¤šã„ã€‚ï¼ˆ2022/10/17 æ™‚ç‚¹ã§ 9.9kï¼‰
4. Go ã§æ›¸ã‹ã‚Œã¦ã‚‹ï¼ˆä¸­èº«ã‚’èª­ã¿ãŸã„è¨³ã§ã¯ãªã„ã‘ã©ã‚‚ã€æ°—ã«å…¥ã£ã¦ã‚‹è¨€èªã§æ›¸ã‹ã‚Œã¦ã‚‹æ–¹ãŒæ°—åˆ†ãŒä¸ŠãŒã‚‹ã€‚ï¼‰

PostgreSQL ã¨ MongoDB ã§è©¦ã—ã¦ã¿ãŸã‚“ã§ã™ãŒã€MongoDB ã®æƒ…å ±ãŒã‚ã¾ã‚Šè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã®ã§ã€MongoDB ä¸­å¿ƒã«è¨˜è¼‰ã—ã¾ã™ã€‚
ç‰¹ã«`docker-compose.yml`ã¨`docker run`ã‚’ä½¿ã£ã¦ Docker ã‚³ãƒ³ãƒ†ãƒŠä¸Šã§å‹•ä½œç¢ºèªã™ã‚‹æƒ…å ±ãŒè¦‹å½“ãŸã‚‰ãªã‹ã£ãŸã®ã§ã€ãã“ã‚‰è¾ºã‚’ä¸­å¿ƒã«è¨˜è¼‰ã—ã¾ã™ã€‚
golang-migrate ã‚’ã‚³ãƒ³ãƒ†ãƒŠã§ã‚„ã‚ŠãŸã„ã‚“ã ï¼ã£ã¦äººã®å‚è€ƒã«ãªã‚Œã°ã¨æ€ã„ã¾ã™ã€‚

ã¡ãªã¿ã«èª¿æŸ»ã®åˆã‚ã¯ã€é–‹ç™ºã«ä½¿ã£ã¦ã‚‹è¨€èªã«å¯¾å¿œã—ã¦ã‚‹ãƒ„ãƒ¼ãƒ«ã˜ã‚ƒãªã„ã¨ã„ã‘ãªã„ã‹ãªãƒ¼ã¨æ€ã£ã¦ãŸã‘ã©ã€ORM (Object-Relational Mapping) ä½¿ã‚ãªã‹ã£ãŸã‚‰ã€ãã‚“ãªåˆ¶ç´„ãªã„ã®ã‹ã¨æ°—ã¥ã„ã¦ã€golang-migrate è©¦ã™ã“ã¨ã«ã—ã¾ã—ãŸã€‚

ä»¥ä¸‹ã§ã¯ã€MongoDB ã§ã®ç’°å¢ƒæ§‹ç¯‰ãƒ»ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®å‹•ä½œç¢ºèªã€ã‚³ãƒ³ãƒ†ãƒŠã§ã®å‹•ä½œç¢ºèªã€æœ€å¾Œã« PostgreSQL ã§ã®å‹•ä½œç¢ºèªã®é †ã§èª¬æ˜ã—ã¾ã™ã€‚

# MongoDB

## ç’°å¢ƒæ§‹ç¯‰

ã¾ãšã€docker compose ã‚’ä½¿ã£ã¦ã€MongoDB ã¨ PostgreSQL ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œã‚Šã¾ã™ã€‚

ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã€ãƒãƒ¼ãƒˆã®è¨­å®šã‚‚ã—ã¦ã¾ã™ã€‚
å¾ŒåŠã§ã€å…¬å¼ã®ã‚³ãƒ³ãƒ†ãƒŠï¼ˆ[migrate/migrate](https://hub.docker.com/r/migrate/migrate)ï¼‰ã‚’ç«‹ã¡ä¸Šã’ã¦ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹æ–¹æ³•ã‚‚æ›¸ã„ã¦ã¾ã™ãŒã€ãã®å ´åˆã€ãƒãƒ¼ãƒˆã®è¨­å®šã¯ä¸è¦ã§ã™ã€‚

ä½¿ã£ã¦ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯ã€[MongDB ã®å…¬å¼ã®ã‚„ã¤](https://hub.docker.com/_/mongo/)ã‚’ä½¿ã£ã¦ã¾ã™ã€‚

```yml:docker-compose.yml
version: "3"
services:
  mongo:
    image: mongo
    ports:
      - 27017:27017
    networks:
      - network
    volumes:
      - mongo_db_data:/data/db
      - ./initdb.d:/docker-entrypoint-initdb.d/
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: password
  postgres:
    image: postgres:14.1-alpine
    ports:
      - 5432:5432
    networks:
      - network
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin-password
      LANG: ja_JP.utf8
      TZ: Asia/Tokyo
volumes:
  postgres_data:
  mongo_db_data:
networks:
  network:
```

åŠ ãˆã¦ã€äº‹å‰æº–å‚™ã¨ã—ã¦ã€èªè¨¼ã®è¨­å®šã™ã‚‹ãŸã‚ã«ã€å°‘ã—çœŸé¢ç›®ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¨­å®šã—ã¦ã„ã¾ã™ã€‚
ä¸‹è¨˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ã“ã¨ã§ã€ã‚³ãƒ³ãƒ†ãƒŠç«‹ã¡ä¸Šã’æ™‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¦ãã‚Œã¾ã™ã€‚

```js:initdb.d/init.js
db = db.getSiblingDB("admin");
db.auth("root", "password");
db.createUser({
  user: "testuser",
  pwd: "password",
  roles: [
    {
      role: "readWrite",
      db: "hoge",
    },
  ],
});
```

ã“ã‚Œã§ã€å‹•ãã¯ãšã§ã™ãŒã€MongoDB ã®ã“ã¨ã‚‚ã†ã¡ã‚‡ã„çŸ¥ã‚ŠãŸã„äººã¯ã€ä»¥å‰æ›¸ã„ãŸè¨˜äº‹ï¼ˆ[ã¯ã˜ã‚ã¦ã® MongoDB with Docker](https://zenn.dev/optimisuke/articles/d6b248d45f4f5c)ï¼‰ã‚’èª­ã‚“ã§ã‚‚ã‚‰ãˆã‚‹ã¨å¬‰ã—ã„ã§ã™ã€‚

åŠ ãˆã¦ã€å‹•ä½œç¢ºèªã®ãŸã‚ã«ãƒ­ãƒ¼ã‚«ãƒ«ã§`mongosh`ã‚’ä½¿ã£ãŸã®ã§ã€ä¸‹è¨˜ã‚’å‚ç…§ã—ã¦ MongoDB ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã—ãŸã€‚
[Install MongoDB Community Edition on macOS â€” MongoDB Manual](https://www.mongodb.com/docs/manual/tutorial/install-mongodb-on-os-x/)

ã¾ãŸã€`golang-migrate/migrate`ã¯ MacOS ã‚’ä½¿ã£ã¦ã‚‹ã®ã§ã€ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§å…¥ã‚Œã¾ã—ãŸã€‚

```bash
brew install golang-migrate
```

ã‚³ãƒ³ãƒ†ãƒŠã®ã¿ä½¿ã†ã®ã§ã‚ã‚Œã°ã€ä¸Šè¨˜ä¸è¦ã§ã™ãŒã€ã„ããªã‚Šã‚³ãƒ³ãƒ†ãƒŠã§ç¢ºèªã™ã‚‹ã«ã¯ä¸å®‰ãŒã‚ã£ãŸã®ã§å…¥ã‚Œã¦ç¢ºèªã—ã¾ã—ãŸã€‚
ä»–ã® OS ã®å ´åˆã¯ã€ä¸‹è¨˜ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‚ç…§ã§ã™ã€‚
[migrate/cmd/migrate at master Â· golang-migrate/migrate](https://github.com/golang-migrate/migrate/tree/master/cmd/migrate)

## ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®å‹•ä½œç¢ºèª

PostgreSQL ã¯ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«([migrate/TUTORIAL.md](https://github.com/golang-migrate/migrate/blob/master/database/postgres/TUTORIAL.md))ãŒã‚ã‚Šã¾ã™ãŒã€MongoDB ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ï¼ˆREADME ï¼ˆ[migrate/database/mongodb](https://github.com/golang-migrate/migrate/tree/master/database/mongodb)ï¼‰ã®ã¿ã€‚PR ã—ã‚ˆã‹ãªã€‚ï¼‰
ãªã®ã§ã€è‰²ã€…èª¿ã¹ãªãŒã‚‰ã€è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚
åŸºæœ¬çš„ã«ã¯ã€PostgreSQL ã¨åŒã˜ãªã®ã§ã™ãŒã€æ¨©é™ã¾ã‚ã‚Šã§ã¤ã¾ã¥ã„ã¦ã¾ã—ãŸã€‚

ã¾ãšã€ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã® up ã¨ down ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚Šã¾ã™ã€‚

```
migrate create -ext json -dir mongo/migrations -seq create_hoge
```

ãã®å¾Œã€ä¸­èº«ã‚’è¨˜è¼‰ã—ã¾ã™ã€‚

ã“ã“ã‚‰ã®è¨˜äº‹ã‚’å‚è€ƒã«ã—ã¾ã—ãŸã€‚

- [migrate/database/mongodb/examples/migrations](https://github.com/golang-migrate/migrate/tree/master/database/mongodb/examples/migrations)
- [golang-migrate ã§ MongoDB ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³](https://zenn.dev/someone7140/articles/cbbd4751b4373a)
- [golang-migrate ã§ MongoDB ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚„ã£ã¦ã¿ãŸ](https://zenn.dev/ytdrep/articles/217e3aeeadd07c)ï¼‰

ä»¥ä¸‹ã«ã€ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼†ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®è¿½åŠ ã¨ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®å‰Šé™¤ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨˜è¼‰ã—ã¾ã™ã€‚

```json:mongo/migrations/000001_create_hoge.up.json
[
    {
        "insert": "hoge",
        "documents": [
            {
                "column1": "test1",
                "column2": "test2"
            }
        ]
    }
]
```

```json:mongo/migrations/000001_create_hoge.down.json
[
  {
    "drop": "hoge"
  }
]
```

ä¸Šè¨˜å‚ç…§å…ˆã«ã€ä»–ã«ã‚‚ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ ã—ãŸã‚Šã™ã‚‹æ–¹æ³•ãŒæ›¸ã‹ã‚Œã¦ã¾ã™ã€‚

æ¬¡ã«ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿæ–½ã—ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æ¥ç¶šæƒ…å ±ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã¨ã‚µãƒ–ã‚³ãƒãƒ³ãƒ‰ã® up/down ã‚’æ›¸ã„ã¦ã¾ã™ã€‚

```bash
migrate -database "mongodb://testuser:password@localhost:27017/hoge?authSource=admin" -path ./mongo/migrations up
```

```bash
migrate -database "mongodb://testuser:password@localhost:27017/hoge?authSource=admin" -path ./mongo/migrations down
```

ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã® URI ã¯ä¸‹è¨˜å‚ç…§ã§ã™ã€‚ä¸Šè¨˜ã‚³ãƒãƒ³ãƒ‰ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æŒ‡å®šã™ã‚‹`authSource`ã—ã‹è¨­å®šã—ã¦ã¾ã›ã‚“ãŒã€ä»–ã«ã‚‚è‰²ã€…ã‚ã‚‹ã¿ãŸã„ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€`initdb.d/init.js`ã«æ›¸ã„ãŸã‚ˆã†ã«ã€`testuser`ã‚’æŒ‡å®šã—ã¦ã„ã¾ã™ã€‚
[Connection String URI Format â€” MongoDB Manual](https://www.mongodb.com/docs/manual/reference/connection-string/#dns-seedlist-connection-format)

## ã‚³ãƒ³ãƒ†ãƒŠã§ã®å‹•ä½œç¢ºèª

å…¬å¼ã®ã‚³ãƒ³ãƒ†ãƒŠï¼ˆ[migrate/migrate](https://hub.docker.com/r/migrate/migrate)ï¼‰ã‚’ä½¿ã£ã¦ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã™ã‚‹æ–¹æ³•ã‚‚è¨˜è¼‰ã—ã¾ã™ã€‚
ä¸Šè¨˜ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯ã€[migrate/Dockerfile](https://github.com/golang-migrate/migrate/blob/master/Dockerfile)ã§ä½œã£ãŸã‚‚ã®ã®ã‚ˆã†ã§ã™ã€‚
ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã ã‘ã§ãªã`ENTRYPOINT`ã§`migrate`ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã‚‹ã¨ã“ã‚ãŒç‰¹å¾´çš„ã‹ãªã¨æ€ã„ã¾ã™ã€‚

ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ã£ã¦ã€ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹æ–¹æ³•ã¯ã€å…¬å¼ã® README.md ã®[ã“ã“](https://github.com/golang-migrate/migrate#docker-usage)ã«ã‚‚æ›¸ã„ã¦ã¾ã—ãŸã€‚

ã¡ãªã¿ã«ã€æœ€åˆ `docker-compose.yml` ã§ã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¡ä¸Šã’ã£ã±ãªã—ã«ã—ã¦ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ãŸã„æ™‚ã«ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã™ã‚‹æ„Ÿã˜ã«ã—ã‚ˆã†ã‹ãªã¨æ€ã„ã¾ã—ãŸãŒã€`ENTRYPOINT`ã«`migrate`ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã—ãŸã‚‰æ­¢ã‚ã‚‹ç³»ãªã®ã‹ãªã¨æ€ã„ã€ã‚„ã‚ã¾ã—ãŸã€‚
ä»Šå›ã¯ã€`docker run`ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ã¦ã¿ã¾ã—ãŸãŒã€ä¸‹è¨˜ã‚µã‚¤ãƒˆã«ã‚ã‚‹ã‚ˆã†ã«`docker-compose.yml`ã«æ›¸ã„ã¦ã€`docker compose up`ã—ãŸã¨ãã« Migration ã™ã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã®ã‚‚ã‚ã‚Šã ã¨æ€ã„ã¾ã™ã€‚
[database - How to run golang-migrate with docker-compose? - Stack Overflow](https://stackoverflow.com/questions/55779979/how-to-run-golang-migrate-with-docker-compose)

`docker run`ã‚’ä½¿ã£ãŸãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒãƒ³ãƒ‰ã¯ã“ã‚“ãªæ„Ÿã˜ã«ãªã‚Šã¾ã™ã€‚
äº‹å‰ã«ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®è¨­å®šã‚’`docker network ls`ã§ç¢ºèªã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```bash
docker run -v $(pwd)/mongo/migrations:/migrations --network=hello-golang-migrate_network migrate/migrate -path=/migrations/ -database "mongodb://testuser:password@mongo:27017/hoge?authSource=admin" up
```

ä»¥ä¸‹ã®ã‚ˆã†ã«ã€`Dockerfile`ã®`ENTRYPOINT`ã§ã€`migrate`ã‚³ãƒãƒ³ãƒ‰ãŒæŒ‡å®šã—ã¦ã‚ã‚‹ã®ã§ã€ãã‚ŒãŒå®Ÿè¡Œã•ã‚Œã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®`--help`éƒ¨åˆ†ã‚’ä¸Šæ›¸ãã—ã¦ã‚‹æ„Ÿã˜ã§ã™ã€‚

```Dockerfile
ENTRYPOINT ["migrate"]
CMD ["--help"]
```

ã¤ã„ã§ã«ã€Makefile ã¯ã“ã‚“ãªæ„Ÿã˜ã‹ãªã¨æ€ã„ã¾ã™ã€‚ã‚‚ã†ã¡ã‚‡ã„ã€å¤‰æ•°ã‚’ä½¿ã£ãŸæ–¹ãŒè‰¯ã„ã¨æ€ã„ã¾ã™ãŒã€‚

```Makefile
up:
	docker run -v ${PWD}/mongo/migrations:/migrations --network=hello-golang-migrate_network migrate/migrate -path=/migrations/ -database "mongodb://testuser:password@mongo:27017/hoge?authSource=admin" up
down:
	docker run -v ${PWD}/mongo/migrations:/migrations --network=hello-golang-migrate_network migrate/migrate -path=/migrations/ -database "mongodb://testuser:password@mongo:27017/hoge?authSource=admin" down -all
```

æœ€å¾Œã®`-all`ã¯ã€é€”ä¸­ã§ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã«èã„ã¦ãã‚‹è³ªå•ã‚’å…¨ã¦ yes ã§é€²ã‚ã‚‹ãŸã‚ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã™ã€‚
[Add an option to assume "yes" to all prompts Â· Issue #370 Â· golang-migrate/migrate](https://github.com/golang-migrate/migrate/issues/370)

# PostgreSQL

PostgreSQL ã®å ´åˆã¯ã€ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãŒå‰²ã¨ã—ã£ã‹ã‚Šæ›¸ã‹ã‚Œã¦ã‚‹ã®ã§ã€ä¸‹è¨˜ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã™ã‚‹ã®ãŒè‰¯ã„ã¨æ€ã„ã¾ã™ãŒã€å‚è€ƒã¾ã§ã«è¨˜è¼‰ã—ã¾ã™ã€‚
[migrate/TUTORIAL.md at master Â· golang-migrate/migrate](https://github.com/golang-migrate/migrate/blob/master/database/postgres/TUTORIAL.md)

ã“ã¡ã‚‰ã‚‚ã€ã‚·ãƒ³ãƒ—ãƒ«ã«æ›¸ã‹ã‚Œã¦ã¦å‚è€ƒã«ãªã‚Šã¾ã—ãŸã€‚
[golang-migrate ã§ã® PostgreSQL ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‚™å¿˜éŒ²](https://zenn.dev/keyamin/articles/24695c455c1591)

æœ€åˆã« MongoDB ã¨åŒã˜ã‚ˆã†ã«ã€ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
migrate create -ext sql -dir postgres/migrations -seq create_bookmarks_table
```

ãã®ã‚ã¨ã€ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿæ–½ã—ã¾ã™ã€‚

```bash
export POSTGRESQL_URL=postgres://admin:admin-password@localhost:5432/admin?sslmode=disable
migrate -database ${POSTGRESQL_URL} -path postgres/migrations up
```

`docker run`ä½¿ã†å ´åˆã¯ MongoDB ã¨åŒã˜ã‚ˆã†ã«ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œã§ãã¾ã™ã€‚

```bash
docker run -v $(pwd)/postgres/migrations:/migrations --network=hello-golang-migrate_network migrate/migrate -path=/migrations/ -database "postgres://admin:admin-password@postgres:5432/admin?sslmode=disable" up
```

```bash
docker run -v $(pwd)/postgres/migrations:/migrations --network=hello-golang-migrate_network migrate/migrate -path=/migrations/ -database "postgres://admin:admin-password@postgres:5432/admin?sslmode=disable" down -all
```

# ãŠã‚ã‚Šã«

MongoDB ä½¿ã†ã¨ãã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ„ãƒ¼ãƒ«ã£ã¦æœ¬å½“ã«å¿…è¦ãªã®ã‹ï¼Ÿå•é¡Œã‚‚ã‚ã‚‹ã®ã‹ãªã¨æ€ã„ã¾ã™ã€‚ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä½¿ã‚ãªãã¦ã‚‚ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã§ããŸã‚Šã€JavaScript ã§æ“ä½œã§ããŸã‚Šã™ã‚‹ã®ã§ã€‚
ãŸã ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨ã‹ã¡ã‚‡ã£ã¨ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚ŒãŸã‚Šã‚’å®£è¨€å‹ã£ã½ãç®¡ç†ã—ãŸã„ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã‚‚ã‚ã‚‹ã®ã‹ãªã¨æ€ã£ã¦è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚ï¼ˆãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®è€ƒãˆæ–¹ã«ç¸›ã‚‰ã‚Œã¦ã‚‹ã ã‘ãªã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€‚ï¼‰

ä½¿ã„å‹æ‰‹ã¯ã€ã‚·ãƒ³ãƒ—ãƒ«ã§ã¨ã¦ã‚‚è‰¯ã„æ„Ÿã˜ã§ã—ãŸã€‚
ORM ã‚’ä½¿ã£ã¦ãªãã¦ã€RDB ã¨ NoSQL ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’çµ±ä¸€ã—ãŸã„ç­‰ã®è¦ä»¶ãŒã‚ã‚Œã°ã€[golang-migrate/migrate](https://github.com/golang-migrate/migrate)ã¯æœ€é©ãªæ°—ãŒã—ã¾ã™ã€‚

å®Ÿéš›ä½¿ã†æ™‚ã«ã¯ã€ä»¥ä¸‹ã®é …ç›®ã‚’ã‚‚ã†å°‘ã—ã‚±ã‚¢ã™ã‚‹å¿…è¦ãŒã‚ã‚Šãã†ãªã®ã§ã€ãã®ã†ã¡ã¾ãŸè©¦ã—ã¦ã¿ãŸã„ãªã¨æ€ã„ã¾ã™ã€‚

- è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¨ã‹ Makefile ã«ãŒã£ã¤ã‚Šãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¡ã‚ƒã£ã¦ã‚‹ã®ã§ã€ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å–å¾—ã™ã‚‹
- Kubernetes ã¨ã‹ã§é‹ç”¨ã™ã‚‹ã¨ãã«ã€Migration ç”¨ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¦ã‚‹
- Migration ã‚’ CICD ã«çµ„ã¿è¾¼ã‚€
