---
title: "一体いつから、サーバーは JSON を返すと錯覚していた？"
emoji: "⚔️"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [htmx, fastapi, jinja2]
published: true
---

みなさん、この記事読みました？目から鱗ですよね。私もワンオブ htmx 急に気になった人です。

https://zenn.dev/livetoon/articles/04dccf642d324c

Web アプリといえば基本は「SPA (Single-Page Application) + REST API (JSON)」という前提が、いつの間にか当たり前になっていた気がします。PHP や Ruby や Java でもテンプレートエンジンを使った技術スタックがありますが、選択肢から抜けてました。。。記事にある htmx を使った構成では、サーバーは JSON ではなく partial HTML を返します。それをブラウザ側で指定した要素に差し替えるだけ、という仕組みです。テンプレートエンジンと htmx の組み合わせがシンプルで軽量でいい感じですよね。

改めて考えてみると、これでええやんって場面は多い気がします。React がクライアント側で状態管理してるのは too much なことが結構あるはず。

AI Coding Agent で html や Tailwind CSS をいい感じに書いてもらえるのも大きなポイントかと思います。React は、 MUI 等のコンポーネントライブラリを使っていい感じのサイトを作れますが、AI が Tailwind CSS を理解してるからそれでええやんってなってきたのかなと思います。Streamlit や Gradio も良いけど、AI に書いてもらうなら html + Tailwind の方が柔軟だしかっこいいし。

試しに、todo アプリを作ってみた（AI Coding Agent に作ってもらった）んですが、todos を操作するエンドポイントは Response として html を返す感じになりました。todo のリストは template engine の Jinja2 を使っていい感じに返してくれそうです。以下少し抜粋です。

![](/images/htmx.gif)

https://github.com/optimisuke/hello-htmx

todo を作成するときは todo 作ってからリストをレンダリングした html を返してます。

```py
@router.post("/todos", response_class=HTMLResponse)
def create_todo(
    request: Request,
    title: str = Form(...),
    session: Session = Depends(get_session),
    user: str = Depends(require_user),
) -> HTMLResponse:
    services.create_todo(session, title)
    return render_list(request, session)
```

`render_list`部分はこんな感じです。テンプレートを活用してます。

```py
def render_list(request: Request, session: Session) -> HTMLResponse:
    todos = services.list_todos(session)
    return templates.TemplateResponse(
        "partials/todo_list.html", {"request": request, "todos": todos}
    )
```

レスポンスの中身はこんなイメージです。長かったので省略しました。

```html
<div id="todo-list">
  <ul>
    {% for todo in todos %}
    <li>{{ todo.title }}</li>
    {% endfor %}
  </ul>
</div>
```

partial HTML だと React に移行する際に、REST API のインターフェースを決めたりは残ってますが、FastAPI 使ってるだけでも、移行コストは少なそうです。進化的アーキテクチャですね。

追加で調べると、htmx には client-side-templates という拡張もあり、クライアント側で HTML にちょっとかくだけで JSON を受け取って HTML に変換することもできるようなので、こっちも検討すると良いのかなと思います。よりフロントとバックを分離しやすくはなると思います。

https://v1.htmx.org/extensions/client-side-templates/

試しに[PokéAPI](https://pokeapi.co/)でポケモン図鑑を作ってみたら、html だけで簡単にかけてびっくりでした。以下にコード置いてます。

![](/images/poke.gif)

https://github.com/optimisuke/hello-htmx2

ここまで、JavaScript を減らす方向で書いてきましたが一方で、React Server Components (RSC)のように、フロントエンドからサーバー側へ寄っていく流れもあります。当たり前ですが、セキュリティで考えることも増えていきます。htmx の記事が出たのと React の脆弱性が出たのが同じタイミングってのも象徴的だなと思います。フロントエンド開発の延長でバックエンドを作るより、バックエンド開発の延長で画面を作る、という考え方にも納得感があります。

またまた Python の話メインでしたが、別の記事で、Hono + htmx + Cloudflare の記事もありますが、こっちはこっちで、エッジで実行できる良さも加わって htmx のよさが際立ってます。

https://zenn.dev/yusukebe/articles/e8ff26c8507799

最後に、htmx の記事の衝撃を胸に、流行や慣習に引っ張られすぎず、自分のユースケースに本当に合った技術スタックを選べるように、これからも一つひとつの技術と向き合っていきたいなと思います。
