---
title: "NestJSã§Mongoã‚„Axiosã®ã‚¨ãƒ©ãƒ¼ã‚’ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã™ã‚‹æ–¹æ³•"
emoji: "ğŸˆâ€â¬›"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [nestjs, mongo, axios, typescript]
published: true
---

# ã¯ã˜ã‚ã«

NestJS ã§ Mongo ã‚„ Axios ã®ã‚¨ãƒ©ãƒ¼ã‚’ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã—ãŸã®ã§ã€ãã®ãƒ¡ãƒ¢ã€‚
è©³ã—ãã¯å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‚ç…§ã€‚
[Exception filters | NestJS - A progressive Node.js framework](https://docs.nestjs.com/exception-filters)

# æˆ¦ç•¥

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸæ™‚ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«ã„ã„æ„Ÿã˜ã®ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã™å¿…è¦ãŒã‚ã‚‹ã€‚
try-catch ã—ã¦ã€ã‚¨ãƒ©ãƒ¼å‡ºãŸæ™‚ã«ãã‚Œã£ã½ã„ã‚³ãƒ¼ãƒ‰ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã—ãŸã‚‰ã„ã„ã‚“ã ã‘ã©ã€NestJS ã®æ©Ÿèƒ½ã‚’ä½¿ã£ã¦ã„ã„æ„Ÿã˜ã«ã—ãŸã„ã€‚

æœ€åˆè€ƒãˆãŸä½œæˆ¦ã¯ã€ã—ã‹ã‚‹ã¹ãæ¡ä»¶ã§ NestJS ãŒæº–å‚™ã—ã¦ã‚‹`HttpException`ã£ã¦ã„ã†`Error`ã‚¯ãƒ©ã‚¹ã‚’`extend`ã—ãŸã‚¯ãƒ©ã‚¹ã‚’ throw ã—ã¡ã‚ƒã†ã‚„ã¤ã€‚
ã“ã‚“ãªæ„Ÿã˜ã€‚
`throw new HttpException('Forbidden', HttpStatus.FORBIDDEN);`

ã¡ãªã¿ã«ã€Nest ã§ã¯ Built-in HTTP exceptions ã£ã¦ã®ãŒã‚ã£ã¦ã€ã“ã‚“ãªæ„Ÿã˜ã§ã‚‚ã‚¨ãƒ©ãƒ¼ã‚’ throw ã§ãã¡ã‚ƒã†ã€‚ã‚·ãƒ³ãƒ—ãƒ«ã€‚
`throw new ForbiddenException();`

ä¸Šè¨˜æ–¹æ³•ã§ã‚‚ã€ãã“ãã“ã„ã„æ„Ÿã˜ã«ã‚¨ãƒ©ãƒ¼ã‚’ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã§ãã‚‹ã€‚
ãŸã ã€Axios ã¨ã‹ Mongo ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç­‰ã®æƒ…å ±ã‚’è¼‰ã›æ›¿ãˆãŸã‚Šã€å°‘ã—ã‚ã‚“ã©ãã•ã„ã—ã€ã‚³ãƒ¼ãƒ‰ãŒèª­ã¿ã«ãããªã‚Šãã†ã€‚
ãªã®ã§ã€NestJS ã® Exception Filter ã£ã¦æ©Ÿèƒ½ã‚’ä½¿ã£ã¦è‰¯ã„æ„Ÿã˜ã«ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã™ã‚‹ã€‚
å®Ÿéš›ã«ã‚„ã£ã¦ã‚‹ã®ã¯ã€`ExceptionFilter`ã£ã¦å‘¼ã°ã‚Œã‚‹ interface ã‚’å®Ÿè£…ã—ãŸã‚¯ãƒ©ã‚¹ã‚’æº–å‚™ã—ã¦ã€æŒ‡å®šã—ãŸã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸæ™‚ã« NestJS ã« catch ã—ã¦ã‚‚ã‚‰ã£ã¦ã€è‰¯ã„æ„Ÿã˜ã® HTTP ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã¨ json ã‚’è¿”ã—ã¦ã‚‚ã‚‰ã†ã“ã¨ã«ã™ã‚‹ã€‚

# Axios

Axios ã®ã‚¨ãƒ©ãƒ¼ã¯`AxiosError`ã£ã¦ã‚¯ãƒ©ã‚¹ã§ throw ã•ã‚Œã‚‹ã®ã§ã€ãã‚Œã‚’ä¸‹è¨˜ã®ã‚ˆã†ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã‚­ãƒ£ãƒƒãƒã—ãŸæ™‚ã«ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«è¿”ã™ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã¨ json ã‚’æŒ‡å®šã™ã‚‹ã€‚Express ã‹ã‚‰å–ã£ã¦ããŸ`Response`ã£ã¦ Interface ã‚’ä½¿ã£ã¦ response ã‚’ä½œã£ã¦ã‚‹ã€‚ãªã®ã§ Express çš„ãªæ›¸ãæ–¹ã§è¿”ã™ã‚‚ã®ã‚’æ±ºã‚ã¦ã‚‹ã€‚
ä»Šå›ã€ãŠã¾ã‘ã§ã„ãã¤ã‹ã®å¤‰æ•°ã‚’`console.log()`ã—ã¦ã‚‹ã€‚

```ts:axios-exception.filter.ts
import { ExceptionFilter, Catch, ArgumentsHost } from '@nestjs/common';
import { AxiosError } from 'axios';
import { Request, Response } from 'express';

@Catch(AxiosError)
export class AxiosExceptionFilter implements ExceptionFilter {
  catch(exception: AxiosError, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse<Response>();
    const request = ctx.getResponse<Request>();
    const status = exception.response.status;

    console.log({
      timestamp: new Date().toISOString(),
      status: status,
      statusText: exception.response.statusText,
      message: exception.response.data,
      path: request.url,
    });

    response.status(status).json({
      status: status,
      error: exception.response.statusText,
    });
  }
}
```

ã‚·ãƒ³ãƒ—ãƒ«ã«ã€ä¸‹è¨˜ã®ã‚ˆã†ã«ã—ã¦ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«è¨­å®šã—ãŸã€‚é©ç”¨ç¯„å›²ã«åˆ¶é™ã‚’ã‹ã‘ãŸã‹ã£ãŸã‚‰ä»–ã«ã‚‚ã‚„ã‚Šæ–¹ã‚ã‚‹ã®ã§ã€[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.nestjs.com/exception-filters)å‚ç…§ã€‚
ã€‚

```ts:main.ts
async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  app.useGlobalFilters(new AxiosExceptionFilter());
  await app.listen(configuration.port);
}
bootstrap();
```

# Mongo

Mongo ã®ã‚¨ãƒ©ãƒ¼ã¯`MongoError`ã£ã¦ã‚¯ãƒ©ã‚¹ã§ throw ã•ã‚Œã‚‹ã®ã§ã€ãã‚Œã‚’ä¸‹è¨˜ã®ã‚ˆã†ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã‚­ãƒ£ãƒƒãƒã—ãŸæ™‚ã«ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã«è¿”ã™ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã¨ json ã‚’æŒ‡å®šã™ã‚‹ã€‚Axios ã¨ã»ã¼åŒã˜ã€‚

```ts:
import { ExceptionFilter, Catch, ArgumentsHost } from '@nestjs/common';
import { Response } from 'express';
import { MongoError } from 'mongodb';

@Catch(MongoError)
export class MongoExceptionFilter implements ExceptionFilter {
  catch(exception: MongoError, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse<Response>();

    console.log({
      timestamp: new Date().toISOString(),
      status: 400,
      message: exception.message,
    });

    let code = 400;
    if (exception.code === 11000) {
      code = 409;
    }
    response.status(code).json({
      status: code,
      error: exception.message,
    });
  }
}
```

Axios ã®æ™‚ã¨åŒæ§˜ã“ã‚“ãªæ„Ÿã˜ã§é©ç”¨ã™ã‚‹ã€‚

```ts:main.ts
async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  app.useGlobalFilters(new AxiosExceptionFilter());
  app.useGlobalFilters(new MongoExceptionFilter());
  await app.listen(configuration.port);
}
bootstrap();
```

# ãŠã‚ã‚Šã«

NestJS ã® Exception filter ã‚’ä½¿ã†ã“ã¨ã§ã€è‰¯ã„æ„Ÿã˜ã«æ­£å¸¸ç³»ã¨ç•°å¸¸ç³»ã‚’åˆ†ã‘ã¦æ›¸ãã“ã¨ãŒã§ããŸã€‚è‰¯ã„æ„Ÿã˜ã€‚
ä»Šå›ã€ã‚·ãƒ³ãƒ—ãƒ«ã« Express ã‚’ä½¿ã£ãŸã‘ã©ã€ä¼¼ãŸã‚ˆã†ãªæ„Ÿã˜ã§ Fastify ã‚’ä½¿ã£ã¦ã‚‚ã§ãã‚‹ã¯ãšã€‚
generics ä½¿ã£ãŸã‚Šã—ã¦ã‚‹éƒ¨åˆ†ã‚‚å‹‰å¼·ã«ãªã£ãŸã€‚
ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯æ§˜æ§˜ã€‚
