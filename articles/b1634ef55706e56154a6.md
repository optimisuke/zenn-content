---
title: "DELETEとINSERTとUPDATEをひとつのSQLで実施したった"
emoji: "🙆"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---

# はじめに
SQL力が低いので、複雑なクエリ書く必要が出てくるとすぐに時間がとける。

# 調べたリンク
## with
[PostgreSQL: Documentation: 9.1: WITH Queries (Common Table Expressions)](https://www.postgresql.org/docs/9.1/queries-with.html)
[WITH問い合わせ（共通テーブル式）](https://www.postgresql.jp/document/9.4/html/queries-with.html)

平行に処理する

> This alleviates the effects of the unpredictability of the actual order of row updates, and means that RETURNING data is the only way to communicate changes between different WITH sub-statements and the main query.

> このため互いが対象テーブルに行った影響を"見る"ことはできません。これは、行の更新に関する実際の順序が予測できないという影響を軽減し、RETURNINGデータが別のWITH副文と主問い合わせとの間で変更を伝える唯一の手段であることを意味します。

## insert
[PostgreSQL: Documentation: 9.5: INSERT](https://www.postgresql.org/docs/9.5/sql-insert.html#:~:text=ON%20CONFLICT%20DO%20UPDATE%20guarantees,%E2%80%94%20%22UPDATE%20or%20INSERT%22.)

## delete
[DELETE](https://www.postgresql.jp/document/9.2/html/sql-delete.html)
[PostgreSQL: Documentation: 10: DELETE](https://www.postgresql.org/docs/10/sql-delete.html)
[PostgreSQLでJOINした結果をDELETEする | KAILO](https://kailo.jp/post/10)

## array
[PostgreSQL: Documentation: 9.2: Arrays](https://www.postgresql.org/docs/9.2/arrays.html)
[sql - Store select query's output in one array in postgres - Stack Overflow](https://stackoverflow.com/questions/6402043/store-select-querys-output-in-one-array-in-postgres/6402163)
[PostgresQL SQL: Converting results to array - Stack Overflow](https://stackoverflow.com/questions/5723851/postgresql-sql-converting-results-to-array)
[PostgreSQL: Documentation: 9.1: Row and Array Comparisons](https://www.postgresql.org/docs/9.1/functions-comparisons.html)


## row_number()
[PostgreSQL ROW_NUMBER() Explained with Practical Examples](https://www.postgresqltutorial.com/postgresql-row_number/)
[#PostgreSQL Window関数で行番号や順位を抽出 - Qiita](https://qiita.com/nfnoface/items/72609615ede93ecea349)

## WITH ORDINALITY
[PostgreSQL: Documentation: 12: 7.2. Table Expressions](https://www.postgresql.org/docs/12/queries-table-expressions.html)

## go
`pq.StringArray`でわたしてるので、arrayとして認識される。他にも`pq.Int64Array`等もある
[Illustrated Guide to SQLX](https://jmoiron.github.io/sqlx/#namedParams)
[Named parameters don't work with IN statement · Issue #485 · jmoiron/sqlx](https://github.com/jmoiron/sqlx/issues/485)
[loops - How to increment all elements in an array or slice in golang - Stack Overflow](https://stackoverflow.com/questions/53507260/how-to-increment-all-elements-in-an-array-or-slice-in-golang)
