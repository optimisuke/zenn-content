---
title: "ã¯ã˜ã‚ã¦ã®MongoDB with Docker"
emoji: "ğŸƒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [mongodb, docker]
published: false
---

# ã¯ã˜ã‚ã«

MongoDB ã«å…¥é–€ã—ãŸã®ã§ã€å‹‰å¼·ã—ãŸã“ã¨ã‚’ãƒ¡ãƒ¢ã€‚
ç’°å¢ƒä½œã£ã¦ã€åŸºæœ¬æ“ä½œã‚’è©¦ã™ã¨ã“ã‚ã¾ã§ã€‚
ãƒ¬ãƒ—ãƒªã‚«ã‚»ãƒƒãƒˆã¨ã‹ã‚·ãƒ£ãƒ¼ã£ãƒ‡ã‚£ãƒ³ã‚°ã¨ã‹é‹ç”¨ã£ã½ã„è©±ã¯ã‚¹ã‚³ãƒ¼ãƒ—å¤–ã€‚
migration ã‚‚ã‚¹ã‚³ãƒ¼ãƒ—å¤–ã€‚

# MongoDB ã£ã¦ï¼Ÿ

- [MongoDB: The Developer Data Platform | MongoDB | MongoDB](https://www.mongodb.com/)
- MongoDB Inc. ãŒé–‹ç™ºã¨ã‚µãƒãƒ¼ãƒˆã—ã¦ã‚‹ã€‚
- OSS ã ã‘ã©ã€å°‘ã—ç‰¹æ®Šãªãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã€‚
- Server Side Public License (SSPL)ã£ã¦ã„ã†ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ï¼ˆSaaS ã¨ã—ã¦æä¾›ã™ã‚‹ã¨ãã«åˆ¶é™ãŒã‹ã‹ã‚‹ï¼‰
- æ©Ÿèƒ½å¼·åŒ–ã•ã‚ŒãŸå•†ç”¨ç‰ˆã‚‚ã‚ã‚‹
- ç®¡ç†ãƒ„ãƒ¼ãƒ«ã¨ã‹ãƒãƒãƒ¼ã‚¸ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã¨ã‹ãŒã€æœ¬ä½“ã¨åˆ¥ã§æä¾›ã•ã‚Œã¦ã‚‹ã€‚
- NoSQLï¼ˆã‚¹ã‚­ãƒ¼ãƒãƒ¬ã‚¹ã€åŸºæœ¬çµåˆæ“ä½œã—ãªã„ã€ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆã—ã‚„ã™ã„ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†ã—ãªã„ï¼‰
- JSON ã‚’ä½¿ã£ãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæŒ‡å‘ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
- JavaScript ãƒ©ã‚¤ã‚¯ãªã‚¯ã‚¨ãƒª
- DBMS ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã§ 5 ä½
- NoSQL ã§ 1 ä½

# ç’°å¢ƒæ§‹ç¯‰

## docker compose

mongod ãŒå‹•ã„ã¦ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ç”¨æ„ã™ã‚‹ã€‚
å…¬å¼ã¨å…ˆäººã®æƒ…å ±ã‚’å‚è€ƒã«ç’°å¢ƒã‚’æ§‹ç¯‰ã—ãŸã€‚ã‚ã£ã•ã‚Šã§ããŸã€‚

[mongo - Official Image | Docker Hub](https://hub.docker.com/_/mongo/)
[MongoDB ã¨ Mongo-express ã‚’ docker-compose ã§ç«‹ã¡ä¸Šã’ã‚‹ | Yukkuri Machine Learning](https://laid-back-scientist.com/docker-mongo)
[docker-compose ã§ mongoDB ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¦ä½¿ã† - Qiita](https://qiita.com/mistolteen/items/ce38db7981cc2fe7821a)

ãã®ã¾ã¾ã‚³ãƒ”ãƒšã‚‚å¾®å¦™ã‹ãªã¨æ€ã£ã¦ã€3 ç‚¹å¤‰æ›´ã—ãŸã€‚
network ã‚’è¨­å®šã—ã¦ã¿ãŸã®ã¨ã€volume ã®æ›¸ãæ–¹å¤‰ãˆã¦ã¿ãŸã®ã¨ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”¨ã«ç’°å¢ƒå¤‰æ•°è¨­å®šãªã—ã§ã€ã‚‚ã†ä¸€ã¤ mongo ã‚³ãƒ³ãƒ†ãƒŠã‚’ç«‹ã¡ä¸Šã’ã¦ã¿ãŸã®ã¨ã€‚

```yaml:docker-compose.yml
version: "3.1"

services:
  mongo:
    image: mongo
    networks:
      - mongo_network
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: password
    volumes:
      - mongodb_data1:/data/db

  mongo-express:
    image: mongo-express
    networks:
      - mongo_network
    restart: always
    ports:
      - 8081:8081
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: root
      ME_CONFIG_MONGODB_ADMINPASSWORD: password
      ME_CONFIG_MONGODB_SERVER: mongo
    depends_on:
      - mongo

  mongo-client:
    image: mongo
    networks:
      - mongo_network
    restart: always
    volumes:
      - mongodb_data2:/data/db

volumes:
  mongodb_data1:
  mongodb_data2:

networks:
  mongo_network:
```

mongo-express ã‚‚ã™ã‚“ãªã‚Šç¹‹ãŒã£ãŸã€‚
![](/images/d6b248d45f4f5c/Home-Mongo-Express.png)

`docker compose up`ã™ã‚‹ã¨ãã«ã€ä¸‹è¨˜ãƒ¯ãƒ¼ãƒ‹ãƒ³ã‚°ãŒå‡ºã¦ãŸã‘ã©ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§å‹•ã‹ã™ã ã‘ã ã‹ã‚‰ä¸€æ—¦ç„¡è¦–ã™ã‚‹ã“ã¨ã«ã—ãŸã€‚

```
hello-mongo-mongo-express-1  | Server is open to allow connections from anyone (0.0.0.0)
hello-mongo-mongo-express-1  | basicAuth credentials are "admin:pass", it is recommended you change this in your config.js!
```

## auth

ä»¥ä¸‹ã€mongod ãŒå‹•ã„ã¦ã„ã‚‹æ–¹ã«ç’°å¢ƒå¤‰æ•°ã§æŒ‡å®šã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ãŸã¨ã“ã‚ã€‚æœŸå¾…é€šã‚Šãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã€‚ã¡ãªã¿ã«ã€`mongo`ã ã‘ã ã¨ä½•ã‚‚è¦‹ã‚Œãªã„ã®ã§ã€auth ãŒãã„ã¦ãã†ã€‚

```
root@fdce2f3b200a:/# mongo -u root -p password
> show dbs
admin   0.000GB
config  0.000GB
local   0.000GB
> use admin
switched to db admin
> show collections
system.users
system.version
> db.system.users.find()
{ä¸‹è¨˜ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±}
```

```json
{
    "_id": "admin.root",
    "userId": UUID(""),
    "user": "root",
    "db": "admin",
    "credentials": {
        "SCRAM-SHA-1": {
            "iterationCount": 10000,
            "salt": "",
            "storedKey": "",
            "serverKey": ""
        },
        "SCRAM-SHA-256": {
            "iterationCount": 15000,
            "salt": "",
            "storedKey": "",
            "serverKey": ""
        }
    },
    "roles": [
        {
            "role": "root",
            "db": "admin"
        }
    ]
}
```

client ã®æ–¹ã®ã‚³ãƒ³ãƒ†ãƒŠã¯ã€ï¼ˆå½“ãŸã‚Šå‰ã ã‘ã©ï¼‰ä¸‹è¨˜ã®é€šã‚Šã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã€‚

```
root@9807833c9166:/# mongo -u root -p password
MongoDB shell version v5.0.10
connecting to: mongodb://127.0.0.1:27017/?compressors=disabled&gssapiServiceName=mongodb
Error: Authentication failed. :
connect@src/mongo/shell/mongo.js:372:17
@(connect):2:6
exception: connect failed
exiting with code 1
```

client ã®ã‚³ãƒ³ãƒ†ãƒŠã§ã¯ã€ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ mongo ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦æƒ…å ±ã‚’è¦‹ã‚Œã‚‹ã€‚ï¼ˆå½“ãŸã‚Šå‰ã ã‘ã©ï¼‰`system.users`ã¯ãªã„ã€‚

```
root@9807833c9166:/# mongo admin
> show dbs
admin   0.000GB
config  0.000GB
local   0.000GB
> use admin
switched to db admin
> show  collections
system.version
```

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã€ã‚µãƒ¼ãƒãƒ¼å´ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã®ã‚‚ç¢ºèªã§ããŸã€‚host åã¯ mongo ã§ã„ã‘ãŸã€‚

```
> show dbs
root@9807833c9166:/# mongo -u root -p password --host mongo
admin   0.000GB
config  0.000GB
local   0.000GB
> use admin
switched to db admin
> show collections
system.users
system.version
> db.system.users.find()
```

## init.js

æœ€åˆã®ç«‹ã¡ä¸Šã’æ™‚ã«å®Ÿè¡Œã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’èª­ã¿è¾¼ã¾ã›ã‚‹ãŸã‚ã«ã€`docker-compose.yml`ã®`volumes`ã«ä¸‹è¨˜ã‚’è¿½åŠ ã€‚

```yaml
- ./init.js:/docker-entrypoint-initdb.d/init.js:ro
```

ä¸‹è¨˜`init.js`ã‚’æº–å‚™ã™ã‚‹ã“ã¨ã§ã€`test`ã«èª­ã¿æ›¸ãã§ãã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚

```js:init.js
db.createUser({
  user: "testuser",
  pwd: "password",
  roles: [
    {
      role: "readWrite",
      db: "test",
    },
  ],
});
```

è©¦ã—ã«æ¥ç¶šã—ã¦ã¿ãŸã‚‰ã€æœŸå¾…é€šã‚Šèª­ã¿æ›¸ãã§ããŸã€‚

```json
root@b0a9ed9d4807:/# mongo test -u testuser -p password
> show dbs
> show collections
> db.test.insert({"name":"hoge"});
WriteResult({ "nInserted" : 1 })
> show collections
test
> db.test.find()
{ "_id" : ObjectId("62f9040736a0adc30d5e2d3e"), "name" : "hoge" }
>
```

ã¡ãªã¿ã«ã€ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ãƒœãƒªãƒ¥ãƒ¼ãƒ å‰Šé™¤ã—ãªãŒã‚‰ã€ä½•åº¦ã‹è©¦ã—ãŸã€‚down ã ã‘ã ã¨ã€ãƒœãƒªãƒ¥ãƒ¼ãƒ ãŒæ¶ˆãˆãªãã¦ã€ãƒ‡ãƒ¼ã‚¿ã‚‚æ®‹ã‚‹ã‹ã‚‰ã€‚

```
docker compose down --volumes
```

ã“ã“å‚ç…§ã€‚
[docker compose down | Docker Documentation](https://docs.docker.com/engine/reference/commandline/compose_down/)

# åŸºæœ¬æ“ä½œ

collection ã®è¿½åŠ å‰Šé™¤é–²è¦§ã¨ã€Document ã«å¯¾ã™ã‚‹ CRUD æ“ä½œã‚’ç¢ºèªã—ãŸã€‚

```json
> show collections
test
> db.createCollection("mycollection")
{ "ok" : 1 }
> show collections
mycollection
test
> db.mycollection.insert({"name":"hogehoge"});
WriteResult({ "nInserted" : 1 })
> db.mycollection.insert({"name":"fugafuga"});
WriteResult({ "nInserted" : 1 })
> db.mycollection.find();
{ "_id" : ObjectId("62fa453336a0adc30d5e2d3f"), "name" : "hogehoge" }
{ "_id" : ObjectId("62fa454736a0adc30d5e2d40"), "name" : "fugafuga" }
> db.mycollection.find({"name":"hogehoge"});
{ "_id" : ObjectId("62fa453336a0adc30d5e2d3f"), "name" : "hogehoge" }
> db.mycollection.find({"name":"hogehoge"}, {_id:0});
{ "name" : "hogehoge" }
> db.mycollection.update({"_id":ObjectId("62fa453336a0adc30d5e2d3f")}, {$set:{"name":"piyopiyo"}})
WriteResult({ "nMatched" : 1, "nUpserted" : 0, "nModified" : 1 })
> db.mycollection.find();
{ "_id" : ObjectId("62fa453336a0adc30d5e2d3f"), "name" : "piyopiyo" }
{ "_id" : ObjectId("62fa454736a0adc30d5e2d40"), "name" : "fugafuga" }
> db.mycollection.remove({"name":"fugafuga"})
WriteResult({ "nRemoved" : 1 })
> db.mycollection.find();
{ "_id" : ObjectId("62fa453336a0adc30d5e2d3f"), "name" : "piyopiyo" }
> db.mycollection.drop();
true
> show collections
test
```

ã“ã“ã‚’å‚è€ƒã«ã—ãŸã€‚
[MongoDB ãƒ‡ãƒ¼ã‚¿æ“ä½œ(DB, Collection, Document) - ã‚ãã‚ã Bank](https://www.wakuwakubank.com/posts/784-server-mongodb-introduction/)

# ãŠã‚ã‚Šã«

MongoDB ã®åŸºæœ¬çš„ãªã¨ã“ã‚æ‰‹ã‚’å‹•ã‹ã—ãªãŒã‚‰è©¦ã—ã¦ã¿ãŸã€‚
`docker compose`ã§æ¥½ã«ç’°å¢ƒç”¨æ„ã§ãã‚‹ã®ãŒç´ æ™´ã‚‰ã—ã„ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘¨ã‚Šã®æŒ™å‹•ãŒã€èª­ã¿ç‰©ã ã‘ã ã¨ã‚ˆãã‚ã‹ã‚‰ãªã‹ã£ãŸã®ã§ã€è©¦ã—ãªãŒã‚‰ã§ãã¦è‰¯ã‹ã£ãŸã€‚
æ¬¡ã¯ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰æ“ä½œã™ã‚‹éƒ¨åˆ†ã‚’ã‚‚ã†ã¡ã‚‡ã„è©¦ã—ã¦ã„ããŸã„ã€‚

# ãã®ä»–

## `mongosh`

`mongo`ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ã†ã¨ãã«ã€ä¸‹è¨˜å‡ºåŠ›ãŒã‚ã£ãŸã€‚ä»Šå›ã€ã‚·ãƒ³ãƒ—ãƒ«ãªã‚³ãƒãƒ³ãƒ‰ã—ã‹è©¦ã—ã¦ã„ãªã„ã‹ã‚‰ã»ã¨ã‚“ã©å¤‰ã‚ã‚‰ã‚“ã‹ã‚‚ã‚„ã‘ã©ã€ä»Šå§‹ã‚ã‚‹ãªã‚‰ã€`mongosh`ã¦ã®ã‚’ä½¿ã£ãŸæ–¹ãŒè‰¯ã„ã®ã‹ã‚‚ã€‚

```
================
Warning: the "mongo" shell has been superseded by "mongosh",
which delivers improved usability and compatibility.The "mongo" shell has been deprecated and will be removed in
an upcoming release.
For installation instructions, see
https://docs.mongodb.com/mongodb-shell/install/
================
```

## mongo-express

mongo ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ web ã‚¢ãƒ—ãƒªã€‚`Node.js, Express and Bootstrap3`ã§ä½œã£ã¦ã‚‹ã‚‰ã—ã„ã€‚
ã“ã“ã‚‰å‚ç…§ã€‚
[mongo-express/mongo-express: Web-based MongoDB admin interface, written with Node.js and express](https://github.com/mongo-express/mongo-express)
[mongo-express - Official Image | Docker Hub](https://hub.docker.com/_/mongo-express)
[mongodb ã‚’ GUI ã§ã€‚mongo-express - Qiita](https://qiita.com/AkihiroTakamura/items/54c6a5bc1e4d67e94d46)

# å‚è€ƒ

ä»–ã«å‚è€ƒã«ã—ãŸã¨ã“ã‚ã¯ä¸‹è¨˜ã®é€šã‚Šã€‚

- [RDB ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã‚‚ã§ãã‚‹ï¼MongoDB ã®æ§‹ç¯‰ã¨é‹ç”¨å…¥é–€ (æŠ€è¡“ã®æ³‰ã‚·ãƒªãƒ¼ã‚ºï¼ˆNextPublishingï¼‰) | ç›®é»’ è– | éå–¶åˆ©å›£ä½“ãƒ»æ…ˆå–„å›£ä½“ | Kindle ã‚¹ãƒˆã‚¢ | Amazon](https://www.amazon.co.jp/RDB%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%8B%E3%82%A2%E3%81%A7%E3%82%82%E3%81%A7%E3%81%8D%E3%82%8B%EF%BC%81MongoDB%E3%81%AE%E6%A7%8B%E7%AF%89%E3%81%A8%E9%81%8B%E7%94%A8%E5%85%A5%E9%96%80-%E6%8A%80%E8%A1%93%E3%81%AE%E6%B3%89%E3%82%B7%E3%83%AA%E3%83%BC%E3%82%BA%EF%BC%88NextPublishing%EF%BC%89-%E7%9B%AE%E9%BB%92-%E8%81%96-ebook/dp/B09MW2Z87F/ref=sr_1_1?__mk_ja_JP=%E3%82%AB%E3%82%BF%E3%82%AB%E3%83%8A&crid=A1CH2XSSYP8K&keywords=mongodb&qid=1660571957&sprefix=mongodb%2Caps%2C243&sr=8-1)
