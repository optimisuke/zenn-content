---
title: "ãƒ­ãƒ¼ã‚«ãƒ«ã§è©¦ã™ OpenTelemetry with Grafana LGTM ã‚¹ã‚¿ãƒƒã‚¯ ã¨ Python FastAPI"
emoji: "ğŸ”­"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [opentelemetry, grafana, tempo, loki, prometheus]
published: true
---

## ã¯ã˜ã‚ã«

ã¿ãªã•ã‚“ã€è¦³æ¸¬ã—ã¦ã¾ã™ã‹ ğŸ”­ï¼ŸObservability ç•Œéšˆã§æ³¨ç›®ã•ã‚Œã¦ã„ã‚‹ OpenTelemetryï¼ˆOTEL: ãƒ™ãƒ³ãƒ€ãƒ¼ã«ä¾å­˜ã—ãªã„ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªæ¨™æº–ï¼‰ã‚’ãã¡ã‚“ã¨ç†è§£ã—ãŸãã¦ã€æœ€å°ã® Todo API ã‚’é¡Œæã«ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ Grafana LGTMï¼ˆLoki: ãƒ­ã‚°ã€Grafana: å¯è¦–åŒ–ã€Tempo: ãƒˆãƒ¬ãƒ¼ã‚¹ã€Prometheus/Mimir: ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼‰ ã‚¹ã‚¿ãƒƒã‚¯ã‚’åˆ©ç”¨ã—è¦³æ¸¬åŸºç›¤ã‚’çµ„ã¿ã€ã‚³ãƒ¼ãƒ‰ã‚’è§¦ã‚‰ãšã«ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ»ãƒ­ã‚°ãƒ»ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’è¦³æ¸¬ã§ãã‚‹ã‹è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚

Observability å‘¨è¾ºã¯ç’°å¢ƒã‚’ä½œã‚‹ã®ãŒå¤§å¤‰ãªã‚¤ãƒ¡ãƒ¼ã‚¸ãŒã‚ã£ãŸã®ã§ã™ãŒã€Grafana LGTM ãŒå…¨éƒ¨å…¥ã‚Šã§ãƒ­ãƒ¼ã‚«ãƒ«ã§ã‚‚å‹•ãã®ã§ã€éå¸¸ã«ã‚„ã‚Šã‚„ã™ã‹ã£ãŸã§ã™ã€‚ã¾ãŸã€ã‚¢ãƒ—ãƒªå´ã‚‚ Coding Agent ãŒä½œã£ã¦ãã‚ŒãŸã®ã§æ¯”è¼ƒçš„ç°¡å˜ã«æº–å‚™ã§ãã¾ã—ãŸã€‚ãœã²ã€ã„ã‚ã‚“ãªäººã«è©¦ã—ã¦ã‚‚ã‚‰ãˆãŸã‚‰ã¨æ€ã„ã¾ã™ã€‚

## GitHub

ã‚³ãƒ¼ãƒ‰ã¯ã“ã“ã«ãŠã„ã¦ã¾ã™ã€‚è©³ç´°ã¯ã“ã¡ã‚‰ã‚’ã”è¦§ãã ã•ã„ã€‚

https://github.com/optimisuke/hello-otel

## ä½¿ã£ãŸã‚‚ã®ãƒ»ä½œã£ãŸã‚‚ã®

ä»¥ä¸‹ã®ã‚¹ã‚¿ãƒƒã‚¯ã§ä½œã‚Šã¾ã—ãŸã€‚

- **Todo ã‚¢ãƒ—ãƒªã®ã‚¹ã‚¿ãƒƒã‚¯:** FastAPIï¼ˆPython Web ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ï¼‰+ Uvicornï¼ˆASGI ã‚µãƒ¼ãƒï¼‰+ SQLAlchemyï¼ˆORMï¼‰+ Postgresï¼ˆRDBMSï¼‰ã€‚è¦³æ¸¬ç”¨ã®ã‚³ãƒ¼ãƒ‰ã¯æ›¸ã‹ãšã€`opentelemetry-instrument` ã«ä»»ã›ã‚‹ã€‚
- **Observability ã‚¹ã‚¿ãƒƒã‚¯:** grafana/otel-lgtmï¼ˆGrafana: å¯è¦–åŒ–ã€Tempo: ãƒˆãƒ¬ãƒ¼ã‚¹ã€Loki: ãƒ­ã‚°ã€Prometheus/Mimir: ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼‰ï¼‹ `otel/opentelemetry-collector-contrib`ï¼ˆOTel Collector æ‹¡å¼µç‰ˆã€‚OTLP ã‚’å—ã‘ã¦ spanmetrics ã‚’ç”Ÿæˆï¼‰ã€‚

```mermaid
flowchart LR
    A[Todo API] -->|OTLP | C[OTel Collector spanmetrics]
    C -->|OTLP | D[OTel Collector]
    D -->|traces| T[Tempo]
    D -->|logs| L[Loki]
    D -->|metrics| M[Mimir/Prometheus]
    T --- G[Grafana]
    L --- G
    M --- G
```

## ã‚„ã£ãŸã“ã¨

ä»¥ä¸‹ã®é †ã§ä½œã£ã¦ã„ãã¾ã—ãŸã€‚

1. **ã‚¢ãƒ—ãƒªã‚’ä½œã‚‹** â€” Todo CRUD ã‚’æœ€å°ã‚³ãƒ¼ãƒ‰ã§ç”¨æ„ï¼ˆè¨ˆè£…ã‚³ãƒ¼ãƒ‰ãªã—ï¼‰ã€‚
2. **LGTM ã‚’èµ·å‹•** â€” docker-compose ã§ Grafana/Tempo/Loki/Mimir ã‚’ç«‹ã¡ä¸Šã’ã€‚
3. **Collector ã‚’è¿½åŠ ** â€” otelcol-contribï¼ˆOTel Collector æ‹¡å¼µç‰ˆã€‚OTLP å—ä¿¡ï¼‹åŠ å·¥ï¼‰ã‚’æŒŸã¿ã€spanmetricsï¼ˆãƒˆãƒ¬ãƒ¼ã‚¹ã‹ã‚‰ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’é›†ç´„ã™ã‚‹æ©Ÿèƒ½ï¼‰ã‚’æœ‰åŠ¹åŒ–ã—ã¦ appâ†’collectorâ†’LGTM ã«çµŒè·¯å¤‰æ›´ã€‚
4. **ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ç”¨æ„** â€” spanmetrics ã‚’ä½¿ã£ãŸ Todo API Overview ã‚’ Grafana ã«ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã€‚
5. **API ã‚’å©ã„ã¦ç¢ºèª** â€” `/health` ã¨ CRUD ã‚’æˆåŠŸ/å¤±æ•—æ··ãœã¦å®Ÿè¡Œã—ã€ãƒˆãƒ¬ãƒ¼ã‚¹ãƒ»ãƒ­ã‚°ãƒ»ãƒ¡ãƒˆãƒªã‚¯ã‚¹ãŒè¦‹ãˆã‚‹ã“ã¨ã‚’ç¢ºèªã€‚

## é€ã£ã¦ã„ã‚‹ã‚‚ã®

Observability ã¨ã„ãˆã°ã€ã“ã‚Œã§ã™ã‚ˆã­ã€‚ä»¥ä¸‹ 3 ã¤ã‚’é€ã£ã¦ã„ã¾ã™ã€‚

- **ãƒˆãƒ¬ãƒ¼ã‚¹**: FastAPI / Uvicorn(ASGI) / SQLAlchemy ã®è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ«ãƒ¡ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã€‚Tempo ã§ç¢ºèªã€‚
- **ãƒ­ã‚°**: Python `logging` ã‚’ OTLPï¼ˆOpenTelemetry Protocol: gRPC/HTTP ã§ãƒ†ãƒ¬ãƒ¡ãƒˆãƒªã‚’é‹ã¶æ¨™æº–ãƒ—ãƒ­ãƒˆã‚³ãƒ«ï¼‰é€ä¿¡ã—ã€Loki ã§ `{service_name="todo-api"}` ã‚’æ¤œç´¢ã€‚
- **ãƒ¡ãƒˆãƒªã‚¯ã‚¹**:
  - è‡ªå‹•ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆspanmetrics ç³»: `traces_spanmetrics_calls_total`, `traces_spanmetrics_latency_bucket/count` ãªã©ï¼‰
  - ãƒ¬ã‚¤ãƒ†ãƒ³ã‚· p95/p99 ã‚„ãƒ«ãƒ¼ãƒˆåˆ¥ RPS ã¯ `traces_spanmetrics_latency_*` ã‹ã‚‰ç®—å‡ºã€‚
  - PromQLï¼ˆPrometheus Query Languageï¼‰ã§ç®—å‡ºãƒ»å¯è¦–åŒ–ã€‚

## è¦‹ãˆæ–¹

Grafana ã®ç”»é¢ã¯ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚
æœŸå¾…é€šã‚Šã€ã„ã‚ã‚“ãªãƒ‡ãƒ¼ã‚¿ã‚’å–ã‚Œã¾ã—ãŸã€‚

![Todo Dashboard](/images/Todo-API-Overview-Dashboards-Grafana-12-07-2025_12_19_AM.png)
![Traces](/images/Traces-Drilldown-Grafana-12-07-2025_12_19_AM.png)
![Traces (detail)](/images/Traces-Drilldown-Grafana-12-07-2025_12_19_AM1.png)
![Logs](/images/Grafana-Logs-Drilldown-Drilldown-Grafana-12-07-2025_12_19_AM.png)

## ãŠã‚ã‚Šã«

ã‚³ãƒ¼ãƒ‰ã‚’è§¦ã‚‰ãšã« OTEL ã§ãƒˆãƒ¬ãƒ¼ã‚¹/ãƒ­ã‚°/ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’é›†ç´„ã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã—ãŸã€‚ä¸Šæ‰‹ãã„ã£ã¦ã‚ˆã‹ã£ãŸã§ã™ã€‚ç†è§£ãŒã‹ãªã‚Šæ·±ã¾ã‚Šã¾ã—ãŸã€‚
é–“é•ã„ç­‰ã‚ã‚Œã°ã€ã”æŒ‡æ‘˜ãŠé¡˜ã„ã—ã¾ã™ã€‚

## Grafana OTEL-LGTM å‚è€ƒ

https://github.com/grafana/docker-otel-lgtm/
https://grafana.com/blog/2024/03/13/an-opentelemetry-backend-in-a-docker-image-introducing-grafana/otel-lgtm/
https://hub.docker.com/r/grafana/otel-lgtm
