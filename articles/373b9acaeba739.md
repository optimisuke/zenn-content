---
title: "NestJSã§Mongooseã‚„TypeORMã‚’ä½¿ã‚ãšã«MongoDBã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‚·ãƒ³ãƒ—ãƒ«ãªAPIã‚’ä½œã£ã¦ã¿ãŸã€‚"
emoji: "ğŸˆâ€â¬›"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [nestjs, mongodb, typescript]
published: true
---

# ã¯ã˜ã‚ã«

NestJS ã®[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.nestjs.com/)ã‚’è¦‹ã‚‹ã¨ MongoDB ã®æ¥ç¶šæ–¹æ³•ã¨ã—ã¦[Mongoose ä½¿ã£ãŸæ–¹æ³•](https://docs.nestjs.com/techniques/mongodb)ã¨[TypeORM ã‚’ä½¿ã£ãŸæ–¹æ³•](https://docs.nestjs.com/techniques/database)ãŒç´¹ä»‹ã•ã‚Œã¦ã„ã‚‹ã‘ã©ã€æ®‹å¿µãªãŒã‚‰[MongoDB Node Driver (mongodb)](https://www.mongodb.com/docs/drivers/node/current/)ã‚’ä½¿ã£ãŸæ–¹æ³•ã¯æ›¸ã‹ã‚Œã¦ãªã„ã€‚ã©ã†ã‚‚ TypeORM ã® MongoDB å¯¾å¿œã¯ã¾ã ã¾ã å¾®å¦™ãªæ„Ÿã˜ã ã—ã€TypeScript ä½¿ã†ãªã‚‰ Mongoose å¿…è¦ãªã„æ°—ã‚‚ã™ã‚‹ã€‚ã¨ã„ã†ã“ã¨ã§ã€è©¦è¡ŒéŒ¯èª¤ã—ãªãŒã‚‰ã€ã‚·ãƒ³ãƒ—ãƒ«ã«[MongoDB Node Driver (mongodb)](https://www.mongodb.com/docs/drivers/node/current/)ã®ã¿ã§ NestJS ã‹ã‚‰ MongoDB ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ãŸã€‚ã¡ã‚ƒã‚“ã¨å‹•ãã‹ç¢ºèªã™ã‚‹ãŸã‚ã«ã€CRUD ã® API ã‚’ä¸€é€šã‚Šä½œã£ã¦è©¦ã—ã¦ã¿ãŸã€‚

è©¦ã™ã¨ãã€ä¸‹è¨˜ã‚µã‚¤ãƒˆã‚’ã™ã”ãå‚è€ƒã«ã—ãŸã€‚ãŸã ã€ãã®ã¾ã¾ã˜ã‚ƒå‹•ã‹ãªã‹ã£ãŸã®ã§è‰²ã€…ä¿®æ­£ã—ãŸã€‚
[NestJS with MongoDB native driver | by Gustavo Oliveira | Medium](https://gusiol.medium.com/nestjs-with-mongodb-native-driver-9d82e377d55)

ãƒ•ãƒ«ã®ã‚³ãƒ¼ãƒ‰ã¯ã“ã“ã«ç½®ã„ãŸã€‚
[GitHub - optimisuke/hello-nestjs-puremongo](https://github.com/optimisuke/hello-nestjs-puremongo)

:::message

#### TypeORM

[Support Relations in MongoDB Â· Issue #655 Â· typeorm/typeorm Â· GitHub](https://github.com/typeorm/typeorm/issues/655)

ä»Šç¾åœ¨ã€TypeORM ã¯ relations ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ãªã„ã‚‰ã—ã„ã€‚PR ã¯ã‚ã‚‹ã‘ã©ã€ãƒãƒ¼ã‚¸ã•ã‚Œã‚‹ã‹ã¯ã‚ˆãã‚ã‹ã‚‰ãªã„ã€‚ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã˜ã‚ƒãªã„ã‹ã‚‰ã€ã—ã‚‡ã†ãŒãªã„ã‹ã‚‚ã ã‘ã©ã€TypeORM ä½¿ã†ãªã‚‰ã€ç´ ç›´ã«ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒŠãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½¿ã£ãŸã»ã†ãŒè‰¯ã„æ°—ãŒã™ã‚‹ã€‚

#### Mongoose

[MongoDB & Mongoose: Compatibility and Comparison | MongoDB](https://www.mongodb.com/developer/languages/javascript/mongoose-versus-nodejs-driver/)
å…¬å¼ã‚µã‚¤ãƒˆã«ã‚ã‚‹ MongoDB ã¨ Mongoose ã®æ¯”è¼ƒè¨˜äº‹ã€‚ãã‚‚ãã‚‚ ORM ã«å¦å®šçš„ãªäººãŒæ›¸ã„ã¦ã‚‹ã‘ã©ã€Mongoose ä½¿ã†å¼Šå®³ã‚‚ãã‚Œãªã‚Šã«ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã€‚
:::

# ã‚³ãƒ¼ãƒ‰

DB æ¥ç¶šå´ã‹ã‚‰ä¸»è¦ãªéƒ¨åˆ†ã‚’èª¬æ˜ã—ã¦ã„ãã€‚

## DB æ¥ç¶š

ã¾ãšã€`useFactory`ã‚’ä½¿ã£ã¦ã€MongoDB ã«æ¥ç¶šã—ã¦`Db`ã‚’ä½œã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æº–å‚™ã™ã‚‹ã€‚`useFactory`ã¯å‹•çš„ã« provider ã‚’ä½œã£ã¦ãã‚Œã‚‹ã€‚èªè¨¼ã¯çœç•¥ã€‚

```ts:database.module.ts
import { Module } from '@nestjs/common';
import { MongoClient, Db } from 'mongodb';

@Module({
  providers: [
    {
      provide: 'DATABASE_CONNECTION',
      useFactory: async (): Promise<Db> => {
        try {
          const client = await MongoClient.connect('mongodb://127.0.0.1');

          return client.db('test');
        } catch (e) {
          throw e;
        }
      },
    },
  ],
  exports: ['DATABASE_CONNECTION'],
})
export class DatabaseModule {}

```

`userFactory`ä½¿ã†ã‚ˆã†ãª Provider ã¯ã€ã“ã“å‚ç…§ã€‚
[Custom providers | NestJS - A progressive Node.js framework](https://docs.nestjs.com/fundamentals/custom-providers#factory-providers-usefactory)

## ã‚µãƒ¼ãƒ“ã‚¹å‘¨è¾º

æ¬¡ã«ã€å…ˆã»ã©ã®`Db`ã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã‚“ã ã‚Šèª­ã¿è¾¼ã‚“ã ã‚Šã™ã‚‹éƒ¨åˆ†ã€‚ãƒªãƒã‚¸ãƒˆãƒªå±¤ã‚’æŒŸã‚“ã§ã‚‚è‰¯ã„ã®ã‹ã‚‚ã ã‘ã©çœç•¥ã€‚
ãƒã‚¤ãƒ³ãƒˆã¯ã€`Db`ã‚’ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§ Dependency injection ã—ã¦ã‚‹ç‚¹ã¨ã€ã‚¸ã‚§ãƒãƒªã‚¯ã‚¹ã§ User Interface ã‚’æŒ‡å®šã—ãŸã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦ã‚‹ç‚¹ã€‚ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¯å‹ã«ã—ã¦ã‚‚è‰¯ã„ã®ã‹ã‚‚ï¼‰
ã‚¨ãƒ©ãƒ¼ã¯ãã‚“ãªã«è€ƒãˆã¦ãªã„ã‘ã©ã€`NotFoundException()`ã¯ throw ã—ã¦ã¿ãŸã€‚Mongo ã®ã‚¨ãƒ©ãƒ¼ã‚’ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã—ãŸã„æ™‚ã¯[ã“ã“](https://zenn.dev/optimisuke/articles/23121f6a35f4c4)ã‚’å‚ç…§ã€‚

```ts:users.service.ts
import { Injectable, Inject, NotFoundException } from '@nestjs/common';
import { User } from './interfaces/user.interface';
import { CreateUserDto } from './dtos/create-user.dto';
import { UpdateUserDto } from './dtos/update-user.dto';
import { Collection, Db, ObjectId } from 'mongodb';

@Injectable()
export class UsersService {
  collectionUser: Collection<User>;

  constructor(
    @Inject('DATABASE_CONNECTION')
    private db: Db,
  ) {
    this.collectionUser = db.collection<User>('users');
  }

  async find(): Promise<User[]> {
    return await this.collectionUser.find().toArray();
  }

  async findOne(id: string): Promise<User> {
    const response = await this.collectionUser.findOne({
      _id: new ObjectId(id),
    });

    if (!response) {
      throw new NotFoundException();
    }

    return response;
  }

  async create(body: CreateUserDto): Promise<void> {
    await this.collectionUser.insertOne(body);
  }

  async update(id: string, body: UpdateUserDto): Promise<User> {
    const response = await this.collectionUser.findOneAndUpdate(
      {
        _id: new ObjectId(id),
      },
      {
        $set: {
          ...body,
        },
      },
      {
        returnDocument: 'after',
      },
    );
    if (!response.ok) {
      throw new NotFoundException();
    }

    return response.value;
  }

  async delete(id: string): Promise<void> {
    const response = await this.collectionUser.deleteOne({
      _id: new ObjectId(id),
    });

    if (response.deletedCount === 0) {
      throw new NotFoundException();
    }
  }
}

```

User Interface ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚`_id` ã‚’ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã—ã¦ã€ObjectId å‹ã«ã—ã¦ã‚‹ã€‚

```ts:user.interface.ts
import { ObjectId } from 'mongodb';

export interface User {
  _id?: ObjectId;
  name: string;
  email: string;
  age: number;
}

```

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹éƒ¨åˆ†ã¯ã“ã‚“ãªã‚‚ã‚“ã€‚

:::message
`ObjectId`ã®æ¯”è¼ƒãŒå¾®å¦™ã«ã‚„ã‚„ã“ã—ã‹ã£ãŸã®ã§ã€ã“ã“ã‚‰å‚è€ƒã«ã—ã¦è©¦è¡ŒéŒ¯èª¤ã—ãŸã€‚
[mongodb - How do I search for an object by its ObjectId in the mongo console? - Stack Overflow](https://stackoverflow.com/questions/8233014/how-do-i-search-for-an-object-by-its-objectid-in-the-mongo-console)
:::

:::message
update ã™ã‚‹ã¨ãã«ã€æ–°ã—ãç™»éŒ²ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ return ã—ãŸã‹ã£ãŸã®ã§ä¸‹è¨˜ã‚’å‚è€ƒã«ã—ãŸã€‚ã‚·ã‚§ãƒ«ã§ã‚„ã‚‹æ™‚ã¨å¾®å¦™ã«é•ã†ãƒ»ãƒ»ãƒ»ã€‚`returnNewDocument`ã§ã„ã‘ã‚‹ã¨æ€ã£ãŸã‚‰ç„¡ç†ã‚„ã£ãŸã€‚Node.js ç”¨ã® MongoDB Driver ã‚’ä½¿ã†ã¨ãã¯ã€ã“ã†ã„ã†ãƒˆãƒ©ãƒƒãƒ—ãŒã‚ã‚‹ã®ã§è¦æ³¨æ„ï¼ˆè‡ªæˆ’ï¼‰ã€‚
[node.js - Mongodb 4+ findOneAndUpdate() returnNewDocument not working - Stack Overflow](https://stackoverflow.com/questions/68660059/mongodb-4-findoneandupdate-returnnewdocument-not-working)
:::

## ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ãƒ»ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å‘¨è¾º

æ®‹ã‚Šã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯å¤§ã—ãŸã“ã¨ã—ã¦ãªã„ã‘ã©ã€ä¸€å¿œè¨˜è¼‰ã—ã¦ãŠãã€‚

ã¾ãšã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã€‚Create ã‚’ Post, Read ã‚’ Get, Update ã‚’ Put, Delete ã‚’ Delete ã§æ›¸ã„ãŸã€‚ãƒ‘ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’`@Param`ã€ãƒœãƒ‡ã‚£ã‚’`@Body`ã§è¨˜è¼‰ã€‚ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ DTO (Data Transfer Object)ã‚’ä½¿ã£ã¦è¨˜è¼‰ã€‚

```ts:users.controller.ts
import {
  Body,
  Controller,
  Delete,
  Get,
  Param,
  Post,
  Put,
} from '@nestjs/common';
import { CreateUserDto } from './dtos/create-user.dto';
import { UpdateUserDto } from './dtos/update-user.dto';
import { User } from './interfaces/user.interface';
import { UsersService } from './users.service';

@Controller('users')
export class UsersController {
  constructor(private readonly usersService: UsersService) {}

  @Post()
  async create(@Body() createUserDto: CreateUserDto) {
    await this.usersService.create(createUserDto);
  }

  @Put(':id')
  async update(
    @Param('id') id: string,
    @Body() updateUserDto: UpdateUserDto,
  ): Promise<User> {
    return this.usersService.update(id, updateUserDto);
  }

  @Get()
  async findAll(): Promise<User[]> {
    return this.usersService.find();
  }

  @Get(':id')
  async findOne(@Param('id') id: string): Promise<User> {
    return this.usersService.findOne(id);
  }

  @Delete(':id')
  async delete(@Param('id') id: string) {
    return this.usersService.delete(id);
  }
}

```

DTO ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚NestJS ã¯ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚·ãƒ³ãƒ—ãƒ«ã«ã‹ã‘ã‚‹ã€‚æ¥½ã¡ã‚“ã€‚

```ts:create-user.dto.ts
import { IsEmail, IsNotEmpty, IsInt } from 'class-validator';

export class CreateUserDto {
  @IsNotEmpty()
  name: string;

  @IsNotEmpty()
  @IsEmail()
  email: string;

  @IsNotEmpty()
  @IsInt()
  age: number;
}

```

```ts:update-user.dto.ts
import { IsEmail, IsNotEmpty, IsInt } from 'class-validator';

export class UpdateUserDto {
  @IsNotEmpty()
  name: string;

  @IsNotEmpty()
  @IsEmail()
  email: string;

  @IsNotEmpty()
  @IsInt()
  age: number;
}

```

:::message
ãƒ‘ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚‚ DTO ã‚¯ãƒ©ã‚¹ã§ validate ã—ãŸã‹ã£ãŸã‚‰ã€ä¸‹è¨˜ã‚’å‚è€ƒã«ã™ã‚Œã°ã§ããã†ã€‚
[Nest.js ã§@Param ã¨@Query ã‚’ 1 ã¤ã® DTO ã‚¯ãƒ©ã‚¹ã§ Transform ã¨ Validate ã™ã‚‹ TIPS](https://zenn.dev/karino_m/articles/nestjs-id-and-query-01)
:::

ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚`DatabaseModule`ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ã‚‹ã€‚

```ts:users.module.ts
import { Module } from '@nestjs/common';
import { UsersController } from './users.controller';
import { UsersService } from './users.service';
import { DatabaseModule } from '../database/database.module';

@Module({
  imports: [DatabaseModule],
  controllers: [UsersController],
  providers: [UsersService],
})
export class UsersModule {}

```

## ãã®ä»–

æ®‹ã‚Šã®ä¸‹è¨˜ãƒ•ã‚¡ã‚¤ãƒ«ç­‰ã¯ã€[GitHub - optimisuke/hello-nestjs-puremongo](https://github.com/optimisuke/hello-nestjs-puremongo)ã«ç½®ã„ã¦ã‚‹ã®ã§ã€ãã£ã¡å‚ç…§ã€‚`.http`ã¯[REST Client](https://marketplace.visualstudio.com/items?itemName=humao.rest-client)ç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ã€‚API ã®å‹•ä½œç¢ºèªã«ä½¿ç”¨ã€‚

- main.ts
- docker-compose.yml
- .http

# è©¦ã—æ–¹

ã“ã‚“ãªæ„Ÿã˜ã§å‹•ãã¯ãšã€‚git ã¨ Node.js ã¨ Docker ãŒå‹•ãå‰æã€‚

```
git clone https://github.com/optimisuke/hello-nestjs-puremongo
cd hello-nestjs-puremongo
npm install
docker compose up -d
npm run start:dev
```

ã‚ã¨ã¯ã€Postman ã¨ã‹[REST Client](https://marketplace.visualstudio.com/items?itemName=humao.rest-client)ã¨ã‹ã§ã„ã„æ„Ÿã˜ã« API ã‚’å‘¼ã³å‡ºã™ã€‚API ã®ä»•æ§˜ã¯ã€ã‚³ãƒ¼ãƒ‰ã‹`.http`ãƒ•ã‚¡ã‚¤ãƒ«å‚ç…§ã€‚[REST Client](https://marketplace.visualstudio.com/items?itemName=humao.rest-client)ã‚’ä½¿ã†å ´åˆã¯ã€`.http`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ã£ã¦è©¦ã›ã‚‹ã€‚ã™ã”ãä¾¿åˆ©ãªã®ã§æ˜¯éã€‚

MongoDB ã«ãƒ‡ãƒ¼ã‚¿ãŒæ›¸ãè¾¼ã¾ã‚Œã¦ã‚‹ã‹ã¯ã€[MongoDB Compass](https://www.mongodb.com/ja-jp/products/compass)ç­‰ã‚’ä½¿ã£ã¦ç¢ºèªã€‚

ã“ã‚“ãªæ„Ÿã˜ã§è¦‹ã‚Œã‚‹ã¯ãšã€‚

![](/images/2023-01-09-22-29-28.png)
![](/images/2023-01-09-22-28-59.png)

# ãŠã‚ã‚Šã«

ãã‚Œã£ã½ã MongoDB ã«æ¥ç¶šã§ãã¦æº€è¶³ã€‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã¯ã‚‚ã†ã¡ã‚‡ã„è€ƒãˆã¦ã‚‚è‰¯ã„ã‹ã‚‚ã ã‘ã©ã„ã„æ„Ÿã˜ã€‚
åŸºæœ¬çš„ã«ã€ä¾å­˜ã™ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚„ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¯ã§ãã‚‹ã ã‘å°‘ãªã„æ–¹ãŒè‰¯ã„ã¨æ€ã†ã®ã§ã€NestJS ã‚’ä½¿ã†ã¨ã—ã¦ã‚‚ Mongoose ã‚„ TypeORM ã‚’ä½¿ã‚ãšã« MongoDB ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã“ã¨ã¯è‰¯ã„ã“ã¨ã ã¨æ€ã†ã€‚
NestJS ã¨ MongoDB å®Œå…¨ã«ç†è§£ã—ãŸã¨è¨€ã„ãŸã„ã¨ã“ã ã‘ã©ã€NestJS ã‚‚ MongoDB ã‚‚ã¾ã ã¾ã ã‚ˆãã‚ã‹ã£ã¦ãªã„ã®ã§å¼•ãç¶šãè©¦è¡ŒéŒ¯èª¤ã—ã¦ã„ããŸã„ã€‚
