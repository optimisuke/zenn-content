---
title: "gRPC x TypeScript x Dockerã§å‹•ä½œç¢ºèª"
emoji: "ğŸ¦®"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [grpc, typescript, docker]
published: true
---

# ã¯ã˜ã‚ã«

gRPC x TypeScript ã‚’ Docker ã‚³ãƒ³ãƒ†ãƒŠä¸Šã§å‹•ã‹ã—ãŸããªã£ãŸã®ã§ã€docker compose ä½¿ã£ã¦ã€è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚

ä¸­èº«ã¯ã€[å…ˆæ—¥æ›¸ã„ãŸã‚„ã¤](https://zenn.dev/optimisuke/articles/9080de6abfc7fd)ã‚’æµç”¨ã—ãŸã®ã§ã€ãã£ã¡ã‚‚å‚è€ƒã«ã—ã¦ã‚‚ã‚‰ãˆã‚Œã°ã¨æ€ã„ã¾ã™ã€‚

[ãƒ¡ãƒ«ã‚«ãƒªã•ã¾ã•ã¾](https://engineering.mercari.com/blog/entry/20201216-53796c2494/)ã§ã™ã€‚

ã‚³ãƒ¼ãƒ‰ã¯ã€[optimisuke/hello-grpc-node](https://github.com/optimisuke/hello-grpc-node)ã«ç½®ã„ã¦ã¾ã™ã€‚

# ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆ

ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆã¯ã“ã‚“ãªæ„Ÿã˜ã«ã—ã¾ã—ãŸã€‚

```bash
.
â”œâ”€â”€ Makefile
â”œâ”€â”€ README.md
â”œâ”€â”€ backend
â”‚   â”œâ”€â”€ config.ts
â”‚   â”œâ”€â”€ index.ts
â”‚   â”œâ”€â”€ node_modules
â”‚   â”œâ”€â”€ package-lock.json
â”‚   â”œâ”€â”€ package.json
â”‚   â””â”€â”€ proto
â”œâ”€â”€ bff
â”‚   â”œâ”€â”€ config.ts
â”‚   â”œâ”€â”€ helloClient.ts
â”‚   â”œâ”€â”€ index.ts
â”‚   â”œâ”€â”€ node_modules
â”‚   â”œâ”€â”€ package-lock.json
â”‚   â”œâ”€â”€ package.json
â”‚   â”œâ”€â”€ proto
â”‚   â””â”€â”€ tsconfig.json
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ package-lock.json
â””â”€â”€ schema
    â”œâ”€â”€ gen
    â”œâ”€â”€ helloworld.proto
    â”œâ”€â”€ node_modules
    â”œâ”€â”€ package-lock.json
    â””â”€â”€ package.json
```

proto ã¯ã€backend ã¨ bff ã¨ä¸¦åˆ—ã«ç½®ãã“ã¨ã«ã—ã¾ã—ãŸã€‚

# ä¿®æ­£ç‚¹

ä¿®æ­£ç‚¹ã¯ã€å°‘ãªãã¦ã€`docker-compose.yml`ã‚’ä½œã£ãŸéƒ¨åˆ†ã¨ã€bff ã‹ã‚‰ backend ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ãã® URL ã‚’å¤‰æ›´ã—ãŸãã‚‰ã„ã€‚

## docker-compose.yml

`docker-compose.yml`ã¯ã€ã“ã‚“ãªæ„Ÿã˜ã«ã—ã¾ã—ãŸã€‚

```yml:docker-compose.yml
version: "3.1"
services:
  bff:
    image: node:16
    volumes:
      - ./bff:/repo
    working_dir: /repo
    tty: true
    networks:
      - network
    ports:
      - 9000:9000
  backend:
    image: node:16
    volumes:
      - ./backend:/repo
    working_dir: /repo
    tty: true
    networks:
      - network
    ports:
      - 10000:10000
networks:
  network:
```

ã™ã”ãã‚·ãƒ³ãƒ—ãƒ«ã§ã™ã€‚backend ã‚‚`ports`ã‚’æŒ‡å®šã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰ã§ã‚‚ gRPC ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

## URL

gRPC ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã‚ã‚‹ bff ã® URL ã‚’ã“ã‚“ãªæ„Ÿã˜ã§å¤‰ãˆã¾ã—ãŸã€‚

```diff ts:helloClient.ts
- import { host, port } from "./config";
+ import { host, port } from "./config";

- const serverURL = `localhost:${port}`;
+ const serverURL = `${host}:${port}`;
```

```diff ts:config.ts
export const port = 10000;
export const BFFPort = 9000;
+ export const host = 'backend';
```

## Path

ã‚ã¨ã€ç´°ã‹ã„ã§ã™ãŒã€proto ã‹ã‚‰è‡ªå‹•ç”Ÿæˆã—ãŸã‚³ãƒ¼ãƒ‰ã®ãƒ‘ã‚¹ã‚’å¤‰æ›´ã—ã¦ã¾ã™ã€‚lint ã§ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã¨ã“ã‚ã‚’ä¿®æ­£ã—ã¦ã¾ã™ã€‚

# Makefile

æœ€å¾Œã«ã€`.proto`ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã€ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã™ã‚‹ã¨ãã® Makefile ã‚’ã“ã‚“ãªæ„Ÿã˜ã«ã—ã¾ã—ãŸã€‚

```Makefile
# Makefile
OUTPUT=gen
WORK_DIR=/repo
NPM_BIN=$(WORK_DIR)/schema/node_modules/.bin

GRPC_TOOL=$(NPM_BIN)/grpc_tools_node_protoc
TYPESCRIPT_PLUGIN=protoc-gen-ts=$(NPM_BIN)/protoc-gen-ts

COMMAND=$(GRPC_TOOL) --plugin=${TYPESCRIPT_PLUGIN} --js_out=import_style=commonjs,binary:$(OUTPUT) --grpc_out=grpc_js:$(OUTPUT) --ts_out=grpc_js:$(OUTPUT) -I . ./*.proto

.PHONY: protogen

test:
	echo `$(COMMAND)`

protogen:
	docker run --rm -it -v ${PWD}:$(WORK_DIR) -w $(WORK_DIR)/schema node:16 \
	/bin/bash -c "\
	npm install \
	&& rm -rf $(OUTPUT) \
	&& mkdir -p $(OUTPUT) \
	&& $(COMMAND) \
	&& rm -rf ../bff/proto \
	&& cp -r $(OUTPUT) ../bff/proto \
	&& rm -rf ../backend/proto \
	&& cp -r $(OUTPUT) ../backend/proto\
	"
```

backend ã¨ bff ã® Node ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ãã‚ãˆãŸã»ã†ãŒç„¡é›£ã‹ãªã¨æ€ã£ã¦ã€ã“ã£ã¡ã‚‚ã‚³ãƒ³ãƒ†ãƒŠã§ã‚„ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚
ä»Šå›ã€è‡ªå‹•ç”Ÿæˆã—ãŸã‚³ãƒ¼ãƒ‰ã¯ã‚·ãƒ³ãƒ—ãƒ«ã« backend ã¨ bff ã®ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹ã“ã¨ã«ã—ãŸã®ã§ã€æœ€å¾Œã‚„ãŸã‚‰ã”ã¡ã‚ƒã”ã¡ã‚ƒã—ãŸæ„Ÿã˜ã«ãªã£ã¡ã‚ƒã£ã¦ã¾ã™ã€‚æœ¬ç•ªã§ä½¿ã†ã«ã¯ã€ç®¡ç†æ–¹æ³•ã‚’æ¤œè¨ã™ã‚‹å¿…è¦ã‚ã‚Šãã†ã§ã™ã€‚

# ãŠã‚ã‚Šã«

ã‚„ã£ãŸã“ã¨ã¯ãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆè€ƒãˆã¦ã€`docker-compose.yml`æ›¸ããã‚‰ã„ã§ã€ã‚·ãƒ³ãƒ—ãƒ«ã§ã—ãŸãŒã€åœ°å‘³ã«æ™‚é–“ã‹ã‹ã‚Šã¾ã—ãŸã€‚
ä¸€ã¤ã®`package.json`ã§ç®¡ç†ã—ã¦ãŸã‚‚ã®ã‚’åˆ†å‰²ã™ã‚‹æ™‚ã€`package.json`ãŒç½®ã‹ã‚Œã¦ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ã®å¤–ã«ã‚ã‚‹è‡ªå‹•ç”Ÿæˆã—ãŸã‚³ãƒ¼ãƒ‰ã‚’å‚ç…§ã—ã‚ˆã†ã¨ã—ã¦ã€ç›´æ¥çš„ã˜ã‚ƒãªã„ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã‚Šã€Makefile ã®ã‚¨ãƒ©ãƒ¼ãŒã‚ˆãã‚ã‹ã‚‰ãšã€ãªã‹ãªã‹å‹•ã‹ãªã‹ã£ãŸã‚Šã€‚
ã‚„ã£ãŸã‚‰ã§ããã†ãªã“ã¨ã¯ã€ãªã‹ãªã‹æ‰‹ã‚’å‹•ã‹ã™ã®ã‚µãƒœã‚ŠãŒã¡ã§ã™ãŒã€ã‚„ã£ã¦ã¿ã¦ã‚ˆã‹ã£ãŸã‹ãªãƒ¼ã¨æ€ã„ã¾ã—ãŸã€‚
