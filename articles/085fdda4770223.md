---
title: "Deno ğŸ¦• ã§ gRPC ğŸ¦® è©¦ã—ã¦ã¿ãŸ"
emoji: "ğŸ¦•"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [deno, grpc, typescript]
published: true
---

# ã¯ã˜ã‚ã«

æœ€è¿‘ã€å°‘ã— Deno ä½¿ã„å§‹ã‚ãŸã€‚
Deno ã§ gRPC ã‚µãƒ¼ãƒãƒ¼ãƒ»ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã©ã‚“ãªæ„Ÿã˜ã§ã§ãã‚‹ã‚“ã‚„ã‚ã†ã¨æ€ã£ã¦ã€æ¤œç´¢ã®æœ€åˆã«å¼•ã£ã‹ã‹ã£ãŸ[grpc_basic@0.4.6 | Deno](https://deno.land/x/grpc_basic@0.4.6)ã‚’ä½¿ã£ã¦ã¿ã‚‹ã“ã¨ã«ã—ãŸã€‚`Very basic gRPC implementation for Deno`ã‚‰ã—ã„ã€‚

`You probably should wait for more mature and standard aligned implementation`ã£ã¦æ›¸ã„ã¦ã‚ã‚‹ã—ã€ãƒªãƒã‚¸ãƒˆãƒªï¼ˆ[prohazko2/deno-grpc](https://github.com/prohazko2/deno-grpc)ï¼‰è¦‹ã¦ã¿ã‚‹ã¨ã€ä»Šæ—¥ï¼ˆ2022/10/30ï¼‰ç¾åœ¨ã€ã‚¹ã‚¿ãƒ¼ã¯ 36 ã§å¿ƒã‚‚ã¨ãªã„ã‘ã©ã€é›°å›²æ°—ã—ã‚ŒãŸã‚‰è‰¯ã„ã‹ãªã¨æ€ã£ã¦è©¦ã—ã¦ã¿ã‚‹ã“ã¨ã«ã—ãŸã€‚

ï¼ˆä¸€æ–¹çš„ã«çŸ¥ã£ã¦ã‚‹ï¼‰mattn ã•ã‚“ãŒè©¦ã—ã¦ãŸã®ã‚‚ one of ã‚„ã£ã¦ã¿ãŸç†ç”± s
https://twitter.com/mattn_jp/status/1577329836506648577

Issue ã«ã‚‚ä¸ŠãŒã£ã¦ã‚‹ã‹ã‚‰ã€å…¬å¼ã§ã‚‚ãã®ã†ã¡ã‚µãƒãƒ¼ãƒˆã•ã‚Œãã†ã€‚ã©ã‚“ãªæ„Ÿã˜ã«ãªã‚‹ã®ã‹ã€ã„ã¾ã„ã¡ã‚ã‹ã‚“ãªã„ã‘ã©ã‚‚ã€‚

> To give context, we believe that integrated gRPC to the Deno CLI is an important feature and are committing core team resources to delivering it.

[Add support for gRPC Â· Issue #3326 Â· denoland/deno](https://github.com/denoland/deno/issues/3326)

# ã‚³ãƒ¼ãƒ‰

example ãã®ã¾ã¾ã§ã‚‚å‹•ã„ãŸã‘ã©ã€å°‘ã—ä¿®æ­£ã—ãŸã‚Š CLI ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§å‘¼ã³å‡ºã—ãŸã‚Šã—ã¦ã¿ãŸã€‚

## proto

ã¾ãšã€proto ã‚’å®šç¾©

```proto:greeter.proto
syntax = "proto3";

package helloworld;

service Greeter {
  rpc SayHello (HelloRequest) returns (HelloReply) {}
  rpc ShoutHello (HelloRequest) returns (stream HelloReply) {}
}

message HelloRequest {
  string name = 1;
}

message HelloReply {
  string message = 1;
}
```

# ã‚³ãƒ¼ãƒ‰ï¼ˆinterfaceï¼‰ç”Ÿæˆ

ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã€‚

```bash
deno run --allow-read https://deno.land/x/grpc_basic@0.4.6/gen/dts.ts ./greeter.proto > ./greeter.d.ts
```

ã“ã‚“ãªãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã‚‹ã€‚ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãŒå…¥ã£ã¦ã‚‹ã€‚

```ts:greeter.d.ts
/* this code was generated by automated tool,
   should not edit by hand */

export interface Greeter {
  SayHello(request: HelloRequest): Promise<HelloReply>;
  ShoutHello(request: HelloRequest): AsyncGenerator<HelloReply>;
}

export interface HelloRequest {
  name?: string;
}

export interface HelloReply {
  message?: string;
}
```

## ã‚µãƒ¼ãƒãƒ¼

ã“ã‚“ãªæ„Ÿã˜ã§å‹•ã‹ã™ã€‚è‡ªå‹•ç”Ÿæˆã—ãŸã‚³ãƒ¼ãƒ‰ã®ä¸­èº«ã‚’è¨˜è¼‰ã—ã¦`addService()`ã§ç™»éŒ²ã™ã‚‹æ„Ÿã˜ã€‚ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®[ãƒ¡ã‚½ãƒƒãƒ‰](https://developer.mozilla.org/ja/docs/Web/JavaScript/Guide/Working_with_Objects#%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%81%AE%E5%AE%9A%E7%BE%A9)ã£ã½ãæ›¸ã‹ã‚Œã¦ãŸã®ã‚’ã‚¯ãƒ©ã‚¹ã«ã—ã¦ã¿ãŸã€‚

```ts:server.ts
import { GrpcServer } from "https://deno.land/x/grpc_basic@0.4.6/server.ts";
import { Greeter, HelloReply, HelloRequest } from "./greeter.d.ts";

const port = 50051;
const server = new GrpcServer();

const protoPath = new URL("./greeter.proto", import.meta.url);
const protoFile = await Deno.readTextFile(protoPath);

class GreeterImp implements Greeter {
  async SayHello(req: HelloRequest) {
    const message = `hello ${req.name || "stranger"}`;
    return { message: message };
  }

  async *ShoutHello(req: HelloRequest) {
    for (const n of [0, 1, 2]) {
      const message = `hello ${req.name || "stranger"} #${n}`;
      yield { message: message };
    }
  }
}
const greeter = new GreeterImp();
server.addService<Greeter>(protoFile, greeter);

console.log(`gonna listen on ${port} port`);
for await (const conn of Deno.listen({ port })) {
  server.handle(conn);
}
```

å‹•ã‹ã™ã¨ãã¯ã“ã‚“ãªæ„Ÿã˜ã€‚

```bash
deno run --allow-read=./greeter.proto --allow-net server.ts
```

## ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ãã®ã¾ã¾ã€‚RPC ã‚‰ã—ãé–¢æ•°ã£ã½ãå‘¼ã¹ã‚‹ã€‚ç´ æ™´ã‚‰ã—ã„ã€‚

```ts:
import { getClient } from "https://deno.land/x/grpc_basic@0.4.6/client.ts";
import { Greeter } from "./greeter.d.ts";

const protoPath = new URL("./greeter.proto", import.meta.url);
const protoFile = await Deno.readTextFile(protoPath);

const client = getClient<Greeter>({
  port: 50051,
  root: protoFile,
  serviceName: "Greeter",
});

/* unary calls */
console.log(await client.SayHello({ name: "unary #1" }));
console.log(await client.SayHello({ name: "unary #2" }));

/* server stream */
for await (const reply of client.ShoutHello({ name: "streamed" })) {
  console.log(reply);
}

client.close();
```

ã‚³ãƒãƒ³ãƒ‰ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚

```bash
deno run --allow-read=./greeter.proto --allow-net client.ts
```

## CLI ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ

ã¤ã„ã§ã«ã€[Evans](https://github.com/ktr0731/evans)ä½¿ã£ã¦ã€ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ã‚µãƒ¼ãƒãƒ¼ã®å‹•ä½œç¢ºèªã‚’ã—ã¦ã¿ãŸã€‚

```bash
#!/bin/sh
echo '{"name": "hoge"}' | evans --proto greeter.proto -p 50051 cli call helloworld.Greeter.SayHello
echo '{"name": "hoge"}' | evans --proto greeter.proto -p 50051 cli call helloworld.Greeter.ShoutHello
```

# ãŠã‚ã‚Šã«

example ãŒã‚·ãƒ³ãƒ—ãƒ«ã§è‰¯ã„æ„Ÿã˜ã ã£ãŸã®ã§ã€ã™ãå‹•ã„ãŸã€‚example å¤§äº‹ã€‚
ã‚‚ã£ã¨æˆç†Ÿã—ãŸæ–¹æ³•ã‚‚ã‚ã‚‹æ°—ãŒã™ã‚‹ã®ã§ã€ãã®ã†ã¡è©¦ã—ã¦ã¿ãŸã„ã€‚
