---
title: "NestJSã§gRPCã‚’ä½¿ã£ã¦ã¿ãŸ"
emoji: "ğŸ•"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [nestjs, grpc, typescript]
published: true
---

# ã¯ã˜ã‚ã«

NestJS ãŒæ°—ã«ãªã£ã¦èª¿æŸ»ä¸­ã§ã™ã€‚
NestJS ã§ gRPC ä½¿ã†ã¨ã©ã†ãªã‚‹ã®ã‹ãªã¨æ€ã„è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚

ä¸‹è¨˜ã‚µã‚¤ãƒˆã‚’å‚è€ƒã«ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚
åŸºæœ¬çš„ã«ã¯ã€1-2 ã®ãƒ–ãƒ­ã‚°ã‚’ãƒãƒã•ã›ã¦ã‚‚ã‚‰ã£ã¦ã€NestJS ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ã§å‹•ã‹ãªã‹ã£ãŸéƒ¨åˆ†ã‚„ã€proto ã‹ã‚‰ protoc ã‚’ä½¿ã£ã¦ã‚³ãƒ¼ãƒ‰è‡ªå‹•ç”Ÿæˆã™ã‚‹éƒ¨åˆ†ã‚’è¿½åŠ ä¿®æ­£ã—ã¦ã¾ã™ã€‚

1. [ã€NestJSã€‘NestJS ã§ gRPC ã‚’ä½¿ã£ã¦ã¿ãŸ - server ç·¨ - é–‹ç™ºè¦šæ›¸ã¯ã¦ãªç‰ˆ](https://kakkoyakakko2.hatenablog.com/entry/nestjs-grpc-server)
2. [ã€NestJSã€‘NestJS ã§ gRPC ã‚’ä½¿ã£ã¦ã¿ãŸ - client ç·¨ - é–‹ç™ºè¦šæ›¸ã¯ã¦ãªç‰ˆ](https://kakkoyakakko2.hatenablog.com/entry/nestjs-grpc-client)
3. [nest/sample/04-grpc at master Â· nestjs/nest](https://github.com/nestjs/nest/tree/master/sample/04-grpc)
4. [gRPC - Microservices | NestJS - A progressive Node.js framework](https://docs.nestjs.com/microservices/grpc#sample-grpc-service)
5. [NestJS ã§ gRPC API ä½œã‚‹ãªã‚‰ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã¯ ts-proto ã§æ±ºã¾ã‚Š - Qiita](https://qiita.com/vol1003/items/326a074fb1a605651750)

# ç’°å¢ƒæº–å‚™

## NestJS

ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ã€NestJS ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã€ç’°å¢ƒã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

```bash
npm i -g @nestjs/cli
nest new project-name
```

[Documentation | NestJS - A progressive Node.js framework](https://docs.nestjs.com/)

## proto ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã®ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ

ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ã€`Protocol Buffer Compiler`ã§ã‚ã‚‹`protobuf`ã¨ TypeScript ã®å‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚‹`ts-proto`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```
brew install protobuf
npm install ts-proto
```

:::message
ä»–ã«ã‚‚æ–¹æ³•ã‚ã‚‹ã¨æ€ã„ã¾ã™ãŒã€å…¬å¼ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã§ã€`ts-proto`ãŒç´¹ä»‹ã•ã‚Œã¦ãŸã®ã§ã€å®‰å¿ƒæ„Ÿé«˜ã‚ã§ã™ã€‚

> The proto interface can be automatically generated by the ts-proto package, learn more here.

:::
:::message
Mac ä»¥å¤–ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹éš›ã¯ä¸‹è¨˜ãƒªãƒ³ã‚¯å…ˆå‚ç…§ã§ã™
:::

[Protocol Buffer Compiler Installation | gRPC](https://grpc.io/docs/protoc-installation/)
[stephenh/ts-proto: An idiomatic protobuf generator for TypeScript](https://github.com/stephenh/ts-proto)

# ã‚³ãƒ¼ãƒ‰

## proto ã¨å‹ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ

ã‚¹ã‚­ãƒ¼ãƒé§†å‹•é–‹ç™ºã¨ã„ã†ã“ã¨ã§ã€ã¾ãšã¯ã€protoã€‚
proto ã¯ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚rpc ã¯ãƒ‘ã‚¹ã‚«ãƒ«ã‚±ãƒ¼ã‚¹ï¼ˆ[Language Guide](https://developers.google.com/protocol-buffers/docs/proto3#services)ï¼‰ã«ãªã£ã¦ã¾ã™ã€‚

```ts:proto/sample.proto
syntax = "proto3";

package sample;

service AppService {
  rpc FindOne (SampleDataById) returns (SampleData) {}
}

message SampleDataById {
  int32 id = 1;
}

message SampleData {
  int32 id = 1;
  string name = 2;
}
```

ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ã€å‹ãŒæ›¸ã‹ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
:::message
å®Ÿéš›ã¯ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚„ git submodule ã§ç®¡ç†ã™ã‚‹ã®ãŒè‰¯ã„ã¨æ€ã‚ã‚Œã¾ã™ã€‚
:::

```bash
protoc --ts_proto_opt=nestJs=true --plugin=./node_modules/.bin/protoc-gen-ts_proto --ts_proto_out=.. ./src/proto/sample.proto
```

[ts-proto/NESTJS.markdown at main Â· stephenh/ts-proto](https://github.com/stephenh/ts-proto/blob/main/NESTJS.markdown)

ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã¯ä¸‹è¨˜ã®é€šã‚Šã€‚interface ç­‰ãŒå®šç¾©ã•ã‚Œã¦ã¾ã™ã€‚
ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã‚‚ä½¿ç”¨ã™ã‚‹ã®ã§ã€ä¸¡æ–¹ã®ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚³ãƒ”ãƒ¼ã—ã¦ãŠãã¾ã™ã€‚

```ts:sample.ts
/* eslint-disable */
import { GrpcMethod, GrpcStreamMethod } from "@nestjs/microservices";
import { Observable } from "rxjs";

export const protobufPackage = "sample";

export interface SampleDataById {
  id: number;
}

export interface SampleData {
  id: number;
  name: string;
}

export const SAMPLE_PACKAGE_NAME = "sample";

export interface AppServiceClient {
  findOne(request: SampleDataById): Observable<SampleData>;
}

export interface AppServiceController {
  findOne(
    request: SampleDataById
  ): Promise<SampleData> | Observable<SampleData> | SampleData;
}

export function AppServiceControllerMethods() {
  return function (constructor: Function) {
    const grpcMethods: string[] = ["findOne"];
    for (const method of grpcMethods) {
      const descriptor: any = Reflect.getOwnPropertyDescriptor(
        constructor.prototype,
        method
      );
      GrpcMethod("AppService", method)(
        constructor.prototype[method],
        method,
        descriptor
      );
    }
    const grpcStreamMethods: string[] = [];
    for (const method of grpcStreamMethods) {
      const descriptor: any = Reflect.getOwnPropertyDescriptor(
        constructor.prototype,
        method
      );
      GrpcStreamMethod("AppService", method)(
        constructor.prototype[method],
        method,
        descriptor
      );
    }
  };
}

export const APP_SERVICE_NAME = "AppService";
```

## ã‚µãƒ¼ãƒãƒ¼

ã¾ãšã€ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ã€ä¾å­˜ã—ã¦ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãŠãã¾ã™ã€‚

```bash
npm install @grpc/grpc-js
npm install @nestjs/microservices
```

ãƒ¡ã‚¤ãƒ³ã§ã¯ã€`INestMicroservice`ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æŒã¤`app`ã‚’ä½œã£ã¦ã€`listen()`ã—ã¾ã™ã€‚

```ts:main.ts
import { NestFactory } from '@nestjs/core';
import { Transport, GrpcOptions } from '@nestjs/microservices';
import { join } from 'path';

import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.createMicroservice<GrpcOptions>(AppModule, {
    transport: Transport.GRPC,
    options: {
      url: 'localhost:5000',
      package: 'sample',
      protoPath: join(__dirname, 'proto/sample.proto'),
    },
  });
  await app.listen();
}
bootstrap();
```

å‚è€ƒã‚µã‚¤ãƒˆã«æ›¸ã‹ã‚Œã¦ã„ãŸ`listenAsync()`ã¯ deprecated ã—ã¦ã„ã¦ã€ãã‚Œã£ã½ã„ã‚‚ã®ã¨ã—ã¦`listen()`ã‚’ä½¿ã£ãŸã‚‰æœŸå¾…é€šã‚Šå‹•ãã¾ã—ãŸã€‚

[Migration guide - FAQ | NestJS - A progressive Node.js framework](https://docs.nestjs.com/migration-guide#deprecations)

ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã¯ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚`AppServiceController`ç­‰ã¯ proto ã‹ã‚‰ç”Ÿæˆã—ãŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä½¿ã£ã¦ã¾ã™ã€‚

```ts:app.controller.ts
import { Controller } from '@nestjs/common';
import { GrpcMethod } from '@nestjs/microservices';

import { AppServiceController, SampleData, SampleDataById } from './sample';

@Controller()
export class AppController implements AppServiceController {
  @GrpcMethod('AppService')
  findOne(data: SampleDataById): SampleData {
    const items = [
      { id: 1, name: 'John' },
      { id: 2, name: 'Doe' },
    ] as SampleData[];
    const filteredItems = items.filter((item) => item.id === data.id);
    return filteredItems.length > 0 ? filteredItems[0] : ({} as SampleData);
  }
}
```

module ã¯ã“ã‚“ãªæ„Ÿã˜ã€‚

```ts:app.module.ts
import { Module } from '@nestjs/common';

import { AppController } from './app.controller';

@Module({
  controllers: [AppController],
})
export class AppModule {}
```

NestJS ã®è¨­å®šã¯ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚

```json:nest-cli.json
{
  "collection": "@nestjs/schematics",
  "sourceRoot": "src",
  "compilerOptions": {
    "assets": [
      "proto/**/*"
    ]
  }
}
```

å®Ÿè¡Œã¯ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚

```bash
npm start
```

## CLI ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§å‹•ä½œç¢ºèª

[ktr0731/evans](https://github.com/ktr0731/evans)ã‚’ä½¿ã£ã¦å‹•ä½œç¢ºèªã—ã¦ã¿ã¾ã—ãŸã€‚ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§æœŸå¾…é€šã‚Šå‹•ã„ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ã€‚

```bash
 echo '{"id": 2}' | evans --proto server/src/proto/sample.proto -p 5000 cli call sample.AppService.FindOne
```

Mac ã®å ´åˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯ brew ã§å®Ÿè¡Œã§ãã¾ã™ã€‚

```bash
brew install evans
```

[ktr0731/evans: Evans: more expressive universal gRPC client](https://github.com/ktr0731/evans)

## ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ

ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ä¾å­˜ã—ã¦ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚ã‚µãƒ¼ãƒãƒ¼å´ã¨ä¸€ç·’ã§ã™ã€‚

```bash
npm install @grpc/grpc-js
npm install @nestjs/microservices
```

ãƒ¡ã‚¤ãƒ³ã¯ã€BFF (Backend For Frontend)ã‚’æƒ³å®šã—ã¦ port 3000 ã§ API ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¡ä¸Šã’ã¾ã™ã€‚

```ts:main.ts
import { NestFactory } from "@nestjs/core";
import { AppModule } from "./app.module";

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  await app.listen(3000);
}
bootstrap();
```

[BFFï¼ˆBackends For Frontendsï¼‰è¶…å…¥é–€â€•â€•Netflixã€Twitterã€ãƒªã‚¯ãƒ«ãƒ¼ãƒˆãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã‚ºãŒæ¡ç”¨ã™ã‚‹ç†ç”±ï¼šãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹/API æ™‚ä»£ã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–‹ç™ºï¼ˆ1ï¼‰ï¼ˆ1/2 ãƒšãƒ¼ã‚¸ï¼‰ - ï¼ IT](https://atmarkit.itmedia.co.jp/ait/articles/1803/12/news012.html)

ã‚µãƒ¼ãƒ“ã‚¹ã§ã¯ã€proto ã‹ã‚‰ç”Ÿæˆã—ãŸ`AppServiceClient`ã‚’å–å¾—ã—ã¦`findOne()`ã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™ã€‚

```ts:app.service.ts
import { Injectable, OnModuleInit, Inject } from '@nestjs/common';
import { ClientGrpc } from '@nestjs/microservices';
import { Observable } from 'rxjs';
import { AppServiceClient, SampleData, SampleDataById } from './sample';

@Injectable()
export class AppService implements OnModuleInit {
  private sampleService: AppServiceClient;

  constructor(@Inject('SAMPLE_PACKAGE') private client: ClientGrpc) {}

  onModuleInit() {
    this.sampleService = this.client.getService<AppServiceClient>('AppService');
  }

  getSampleData(): Observable<SampleData> {
    return this.sampleService.findOne({ id: 1 } as SampleDataById);
  }
}
```

ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã§ã¯ã€ä¸Šè¨˜ã‚µãƒ¼ãƒ“ã‚¹ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã—ã¦ã¾ã™ã€‚

```ts:app.controller.ts
import { Controller, Get } from '@nestjs/common';
import { Observable } from 'rxjs';

import { AppService } from './app.service';

@Controller()
export class AppController {
  constructor(private readonly appService: AppService) {}

  @Get()
  call(): Observable<any> {
    return this.appService.getSampleData();
  }
}
```

ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã¯ã€ä¾å­˜é–¢ä¿‚ã‚„ gRPC ã®è¨­å®šã‚’è¨˜è¼‰ã—ã¦ã„ã¾ã™ã€‚

```ts:app.module.ts
import { Module } from '@nestjs/common';
import { Transport, ClientsModule } from '@nestjs/microservices';
import { join } from 'path';

import { AppController } from './app.controller';
import { AppService } from './app.service';

@Module({
  imports: [
    ClientsModule.register([
      {
        name: 'SAMPLE_PACKAGE',
        transport: Transport.GRPC,
        options: {
          url: 'localhost:5000',
          package: 'sample',
          protoPath: join(__dirname, 'proto/sample.proto'),
        },
      },
    ]),
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

NestJS ã®è¨­å®šã¯ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚

```json:nest-cli.json
{
  "collection": "@nestjs/schematics",
  "sourceRoot": "src",
  "compilerOptions": {
    "assets": [
      "proto/**/*"
    ]
  }
}
```

å®Ÿè¡Œã¯ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚

```bash
npm start
```

æœ€å¾Œã«ã€ã‚µãƒ¼ãƒãƒ¼ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§ã€[http://localhost:3000](http://localhost:3000/)ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã§ã€æœŸå¾…é€šã‚Š json ãŒè¿”ã£ã¦ãã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã™ã€‚

# ãŠã‚ã‚Šã«

ä»¥å‰ã€ãƒ¡ãƒ«ã‚«ãƒªã®ãƒ–ãƒ­ã‚°ã‚’å‚è€ƒã« TypeScript ã§ gRPC ã‚’ä½¿ã£ã¦ã¿ã¾ã—ãŸãŒã€ä»Šå› NestJS ä¸Šã§é•ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã£ã¦å‹•ä½œç¢ºèªã—ã¾ã—ãŸã€‚gRPC ã®ãƒ„ãƒ¼ãƒ«ãŒè¤‡æ•°ã‚ã£ã¦ã€ä½•ãŒé•ã†ã®ã‹ã€ã¾ã ã„ã¾ã„ã¡ã‚ã‹ã£ã¦ã¾ã›ã‚“ãŒã€NestJS ä½¿ã£ãŸå ´åˆã¯ä»Šå›ã®ã‚„ã‚Šæ–¹ãŒã‚·ãƒ³ãƒ—ãƒ«ã§è‰¯ã•ãã†ãªæ°—ãŒã—ã¾ã—ãŸã€‚ä»Šå¾Œã€Meta ãƒ‡ãƒ¼ã‚¿ã‚’ã‚„ã‚Šã¨ã‚Šã™ã‚‹æ–¹æ³•ãªã©ã€ã‚‚ã†ã¡ã‚‡ã„èª¿ã¹ã¦ã¿ã‚ˆã†ã¨æ€ã„ã¾ã™ã€‚

[OK Google, Protocol Buffers ã‹ã‚‰ç”Ÿæˆã—ãŸã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã£ã¦ Node.js ã§ gRPC é€šä¿¡ã—ã¦ | ãƒ¡ãƒ«ã‚«ãƒªã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°](https://engineering.mercari.com/blog/entry/20201216-53796c2494/)
[gRPC x TypeScript ã‚’ Docker ã§å‹•ã‹ã—ã¦ã¿ãŸ](https://zenn.dev/optimisuke/articles/2e3fa4b0225d43)
[gRPC x TypeScript ã§ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®é€å—ä¿¡](https://zenn.dev/optimisuke/articles/9080de6abfc7fd)
