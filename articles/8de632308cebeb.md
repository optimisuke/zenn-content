---
title: "GraphQL Code Generatorã§ç”Ÿæˆã—ãŸApollo Clientã‚’ä½¿ã£ã¦Star Wars APIã‚’å‘¼ã³å‡ºã—ã¦ã¿ãŸ"
emoji: "ğŸš€"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [graphql, apollo]
published: true
---

## ã¯ã˜ã‚ã«

- GraphQL Code Generator x React ã‚’è©¦ã—ã¦ã¿ãŸ
- é–¢é€£ã™ã‚‹è¨˜äº‹ã‚„ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯ãã‚Œãªã‚Šã«ã‚ã£ã¦ã€ã„ãã¤ã‹è©¦ã—ãŸã‘ã‚Œã©å‹•ã‹ãªã‹ã£ãŸ
- è©¦è¡ŒéŒ¯èª¤ã—ã¦å‹•ãã‚‚ã®ã‚’ä½œã‚ŒãŸã®ã§å…±æœ‰

## ã‚³ãƒ¼ãƒ‰

- ä»Šå›ã®ã‚³ãƒ¼ãƒ‰ã¯ã“ã“ã«ãŠã„ãŸ
- `git clone`ã—ã¦`npm install`ã—ã¦`npm run dev`ã—ãŸã‚‰å‹•ãã¯ãš
- [optimisuke/hello-react-graphql-codegen](https://github.com/optimisuke/hello-react-graphql-codegen)

## ç’°å¢ƒæ§‹ç¯‰

### Vite

- ä»Šå›ã€vite ã‚’ä½¿ã£ã¦ã€React ã®ç’°å¢ƒã‚’æ§‹ç¯‰ã—ãŸ
- create-react-app ã¯ã‚‚ã†å¤ã„ã‚‰ã—ã„ã®ã§ã€‚ã€‚ã€‚
- [Create React App ã¯å½¹å‰²ã‚’çµ‚ãˆã¾ã—ãŸ](https://zenn.dev/nekoya/articles/dd0f0e8a2fa35f)

```bash
$ npm create vite@latest hello-react-graphql-codegen                                      14:50:33
âœ” Select a framework: â€º React
âœ” Select a variant: â€º TypeScript

Scaffolding project in /Users/hoge/Repos/hello-react-graphql-codegen...

Done. Now run:

  cd hello-react-graphql-codegen
  npm install
  npm run dev
```

- å®Ÿè¡Œã—ã¦ã¿ã‚‹

```bash
cd hello-react-graphql-codegen
npm install
npm run dev
```

- å‹•ã„ãŸ

![](/images/2023-07-26-15-37-50.png)

### GraphQL

- GraphQL Code Generator ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ä½œæ¥­ã—ã¦ã¿ã‚‹
- ï¼ˆ[Guide: React and Vue â€“ GraphQL Code Generator](https://the-guild.dev/graphql/codegen/docs/guides/react-vue)ï¼‰
- è‰²ã€…ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
npm i -S graphql
npm i -D typescript ts-node @graphql-codegen/cli @graphql-codegen/client-preset
```

- ã‚¹ã‚¿ãƒ¼ã‚¦ã‚©ãƒ¼ã‚ºã®æƒ…å ±ã‚’å–å¾—ã§ãã‚‹ GraphQL APIï¼ˆ[SWAPI GraphQL API](https://swapi-graphql.netlify.app)ï¼‰ã‹ã‚‰æ˜ ç”»æƒ…å ±ã‚’å–å¾—ã™ã‚‹ã‚³ãƒ¼ãƒ‰ã«ãªã£ã¦ã„ã‚‹
- ã©ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã‚‚ã‚ˆã‹ã£ãŸã‘ã‚Œã©ã€Apollo Client ã‚’è©¦ã™
- `codegen.ts`ã«ã¯ã€ã‚¹ã‚­ãƒ¼ãƒã®å ´æ‰€ã‚„ç”Ÿæˆå…ƒãƒ»ç”Ÿæˆå…ˆã®ãƒ•ã‚©ãƒ«ãƒ€ã®å ´æ‰€ã‚’è¨˜è¼‰ã—ã¦ã„ã‚‹

```ts:codegen.ts
import { CodegenConfig } from '@graphql-codegen/cli'

const config: CodegenConfig = {
  schema: 'https://swapi-graphql.netlify.app/.netlify/functions/index',
  documents: ['src/**/*.tsx'],
  ignoreNoDocuments: true, // for better experience with the watcher
  generates: {
    './src/gql/': {
      preset: 'client'
    }
  }
}

export default config
```

- `App.tsx`ã§ã€`useQuery`ã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿å–å¾—

```tsx:src/App.tsx
import React from 'react'
import { useQuery } from '@apollo/client'

import './App.css'
import Film from './Film'
import { graphql } from '../src/gql'

const allFilmsWithVariablesQueryDocument = graphql(/* GraphQL */ `
  query allFilmsWithVariablesQuery($first: Int!) {
    allFilms(first: $first) {
      edges {
        node {
          ...FilmItem
        }
      }
    }
  }
`)

function App() {
  // `data` is typed!
  const { data } = useQuery(allFilmsWithVariablesQueryDocument, { variables: { first: 10 } })
  return (
    <div className="App">
      {data && <ul>{data.allFilms?.edges?.map((e, i) => e?.node && <Film film={e?.node} key={`film-${i}`} />)}</ul>}
    </div>
  )
}

export default App
```

- `Film.tsx`ã§ã€å–å¾—ã—ãŸæƒ…å ±ã®ãƒ•ã‚£ãƒ«ãƒ ã® fragment ã‚’åˆ‡ã‚Šå‡ºã—ã¦ã€è¡¨ç¤º

```tsx:src/Film.tsx
import { FragmentType, useFragment } from './gql/fragment-masking'
import { graphql } from '../src/gql'

export const FilmFragment = graphql(/* GraphQL */ `
  fragment FilmItem on Film {
    id
    title
    releaseDate
    producers
  }
`)

const Film = (props: {
  /* `film` property has the correct type ğŸ‰ */
  film: FragmentType<typeof FilmFragment>
}) => {
  const film = useFragment(FilmFragment, props.film)
  return (
    <div>
      <h3>{film.title}</h3>
      <p>{film.releaseDate}</p>
    </div>
  )
}

export default Film
```

- ã‚¬ã‚¤ãƒ‰ã«æ›¸ã‹ã‚Œã¦ã„ãŸä¸Šè¨˜ä½œæ¥­ã ã‘ã˜ã‚ƒå‹•ã‹ãªã‹ã£ãŸ

### Update

- [TypeScript with Apollo Client - Apollo GraphQL Docs](https://www.apollographql.com/docs/react/development-testing/static-typing/)ã‚‚å‚è€ƒã«ã—ãŸ
- ã“ã£ã¡ã‚‚ [Get started with Apollo Client - Apollo GraphQL Docs](https://www.apollographql.com/docs/react/get-started/)
- `main.tsx`ã§`ApolloClient()`ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã¦ã€`<ApolloProvider>`ã§å›²ã†ã“ã¨ã§ã€client ã‚’ä½¿ã£ã¦`useQuery`ã‚’å‘¼ã¹ã‚‹ã‚ˆã†ã«ã™ã‚‹

```ts:main.tsx
import React from "react";
import ReactDOM from "react-dom/client";
import App from "./App.tsx";
import "./index.css";
import {
  ApolloClient,
  ApolloProvider,
  HttpLink,
  InMemoryCache,
} from "@apollo/client";

const client = new ApolloClient({
  cache: new InMemoryCache(),
  link: new HttpLink({
    uri: "https://swapi-graphql.netlify.app/.netlify/functions/index",
  }),
});

ReactDOM.createRoot(document.getElementById("root")!).render(
  <React.StrictMode>
    <ApolloProvider client={client}>
      <App />
    </ApolloProvider>
  </React.StrictMode>
);
```

- `@graphql-codegen/client-preset`ã‚’å…¥ã‚ŒãŸã‚‰ã€`@apollo/client`å¿…è¦ãªã„ã¨æ€ã£ãŸã‘ã‚Œã©ã€ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã®ã§å…¥ã‚ŒãŸã€‚

```bash
npm i @apollo/client
```

- `codegen`ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚‚å‹•ãã‚ˆã†ã«å¤‰æ›´
- ã“ã®è³‡æ–™ã‚‚å‚è€ƒã«ã—ãŸ â†’ [ESM TypeScript Usage â€“ GraphQL Code Generator](https://the-guild.dev/graphql/codegen/docs/getting-started/esm-typescript-usage)

```json:package.json
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "lint": "eslint . --ext ts,tsx --report-unused-disable-directives --max-warnings 0",
    "preview": "vite preview",
    "codegen": "graphql-codegen-esm --config codegen.ts"
  },
```

- ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚’å®Ÿè¡Œ
- å‹•ã„ãŸ

```bash
npm run codegen
```

## å‹•ä½œç¢ºèª

- [SWAPI GraphQL API](https://swapi-graphql.netlify.app)ã‹ã‚‰å‹•ä½œç¢ºèª

![](/images/2023-07-26-15-44-22.png)

- `npm run dev`ã§å‹•ä½œç¢ºèª

![](/images/2023-07-26-15-44-37.png)

- å‹•ã„ãŸ

## ãŠã‚ã‚Šã«

- ã¾ã ã€ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆé »åº¦ãŒé«˜ã„ã¨ã“ã‚ãªã®ã‹ãªã¨æ€ã†
- `create-react-app`ãŒéæ¨å¥¨ã£ã½ããªã£ã¦ã„ãŸã‚Šã€[apollographql/apollo-tooling](https://github.com/apollographql/apollo-tooling#code-generation)ãŒ Deprecated ã«ãªã£ã¦ãŸã‚Šã€ã¡ã‚ƒã‚“ã¨èª¿ã¹ãªã„ã¨ã„ã‘ãªã„æ„Ÿã˜ã™ã‚‹
- ã¨ã‚Šã‚ãˆãšã€å‹•ã„ã¦ã‚ˆã‹ã£ãŸ
