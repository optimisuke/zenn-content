---
title: "LangChain.js x Next.js ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®Supabaseã®è¨­å®šæ–¹æ³•"
emoji: "âš¡ï¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [langchain, langchainjs, supabase, postgresql, openai]
published: true
---

# ã¯ã˜ã‚ã«

[LangChain x Next.js ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ](https://github.com/langchain-ai/langchain-nextjs-template)ã‚’è©¦ã—ã¦ã„ã¦ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚µãƒ¼ãƒ“ã‚¹ã§ã‚ã‚‹ Supabase ã®è¨­å®šã§å°‘ã—è¿·ã£ãŸã®ã§è¨˜éŒ²ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚ã™ã”ãè‰¯ã„ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãªã®ã§ã€LangChain ã«èˆˆå‘³ã‚ã‚‹ã‘ã©ã€Python ã¯æ›¸ããŸããªã„ã£ã¦äººã¨ã‹ãŒè§¦ã£ã¦ã¿ãŸã‚‰ã„ã„ã¨æ€ã„ã¾ã™ï¼ˆPython æ›¸ãäººã‚‚è§¦ã£ãŸã‚‰ã„ã„ã¨æ€ã„ã¾ã™ï¼‰ã€‚

https://github.com/langchain-ai/langchain-nextjs-template

ä¸Šè¨˜ [github](https://github.com/langchain-ai/langchain-nextjs-template) ã®ã‚¢ãƒ—ãƒªã¯ä¸‹è¨˜ãƒªãƒ³ã‚¯ã‹ã‚‰å®Ÿéš›ã«è©¦ã™ã“ã¨ãŒã§ãã¾ã™ã€‚
https://langchain-nextjs-template.vercel.app/

æ™®é€šã® Chat ã‚¢ãƒ—ãƒªã‚„ã€LLM ã¨ä»–ã® API ã‚’é€£æºã™ã‚‹ Agents ã‚„ã€DB ã®æƒ…å ±ã¨é€£æºã—ã¦å›ç­”ã‚’ç”Ÿæˆã™ã‚‹ Retrieval ç­‰ã€ä¸»è¦ãª LLM æ´»ç”¨æ³•ã®å®Ÿè£…ã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

ç”»é¢ã¯ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚
![](/images/2023-11-17-22-59-15.png)

ãŸã ã€Retrieval ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¯ Supabase ã¨é€£æºã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ä¸Šè¨˜ãƒªãƒ³ã‚¯ã§ã¯è©¦ã›ã¾ã›ã‚“ã§ã—ãŸã€‚
Upload ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ demo mode ã§ã¯ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ãªã„ã£ã¦è¨€ã‚ã‚Œã¾ã™ã€‚
![](/images/2023-11-17-22-59-39.png)

å‹•ã‹ã—ã¦ã¿ãŸã‹ã£ãŸã®ã§ã€Supabase ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½œã£ã¦ã€API key ã‚’æº–å‚™ã—ã€è‡ªåˆ†ã®ç’°å¢ƒã§è©¦ã—ã¦ã¿ã¾ã—ãŸã€‚
ç¹°ã‚Šè¿”ã—ã«ãªã‚Šã¾ã™ãŒã€ã™ã”ãæœ‰ç”¨ãªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãªã®ã§ã€å¤šãã®äººãŒè©¦ã›ã‚‹ã‚ˆã†ã«å¼•ã£ã‹ã‹ã£ãŸã¨ã“ã‚ã‚’æ®‹ã—ã¦ãŠãã¾ã™ã€‚

# Supabase ã®è¨­å®š

ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ä¸­ã§ã¯ã€RAG (Retrieval Augumented Generation)ã®å®Ÿè£…ã§ã€ãƒ™ã‚¯ã‚¿ãƒ¼ã‚¹ãƒˆã‚¢ã¨ã—ã¦ Supabase ä½¿ã£ã¦ã„ã¾ã™ã€‚RAG ã¨ã¯ã€æ¤œç´¢ã§æ‹¡å¼µã—ãŸæ–‡ç« å›ç­”ç”Ÿæˆã£ã¦æ„Ÿã˜ã‹ãªã¨æ€ã„ã¾ã™ã€‚è©³ã—ãã¯æ¤œç´¢ã—ã¦ã¿ã¦ãã ã•ã„ã€‚ã¾ãŸã€Supabase ã¯ PostgreSQL ã®ã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚PostgreSQL ã‚‚ãƒ™ã‚¯ã‚¿ãƒ¼ã‚¹ãƒˆã‚¢ã¨ã—ã¦ä½¿ãˆã‚‹ã“ã¨çŸ¥ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚

https://supabase.com/

Supabase ã®è¨­å®šæ–¹æ³•ã¯ã€å…ˆã»ã©ã® github ã® README ã«ã¯[ãƒªãƒ³ã‚¯](https://js.langchain.com/docs/integrations/vectorstores/supabase)ã‚’èª­ã‚ã£ã¦æ›¸ã‹ã‚Œã¦ã„ãŸã®ã§ç¢ºèªã—ã¾ã—ãŸã€‚ã‚ã¾ã‚Šè¦ªåˆ‡ã§ã¯ãªã„ã§ã™ã€‚ã—ã‚Œã£ã¨ SQL ãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹ã®ã§ã€ã“ã‚Œã‚’ Supabase ã§å®Ÿè¡Œã—ã¦ã„ãã¾ã™ã€‚
ï¼ˆ`npm install`ã®å¾Œã« SQL æ›¸ã‹ã‚Œã¦ã„ã‚‹ã®ã§è„³ãŒãƒã‚°ã£ã¦æœ€åˆã€ç„¡è¦–ã—ã¦ã¾ã—ãŸ ğŸ˜‡ï¼‰

https://js.langchain.com/docs/integrations/vectorstores/supabase

ã‚‚ã†å°‘ã—è©³ã—ã„ã“ã¨ã¯ã“ã“ã«æ›¸ã‹ã‚Œã¦ã¾ã™ã€‚é›°å›²æ°—ã ã‘è¦‹ã‚‹ã¨ã€sql ã‚„ RAG å®Ÿè£…ã®ãŸã‚ã® JavaScript ã®ã‚³ãƒ¼ãƒ‰ãŒæ›¸ã‹ã‚Œã¦ãã†ã§ã—ãŸã€‚Deno ã‚‚ä½¿ã£ã¦ã¦ã„ã„æ„Ÿã˜ãªæ°—ãŒã—ã¾ã™ã€‚

https://supabase.com/blog/openai-embeddings-postgres-vector

ã‚„ã‚‹ã“ã¨ãŒã‚ã‹ã£ãŸã®ã§ã€ã¾ãšã¯ã€[Supabase](https://supabase.com/)ã«ã„ã£ã¦ã€`Start your project`ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¨`project`ã‚’ä½œæˆã—ã¾ã™ã€‚

![](/images/2023-11-17-22-40-44.png)

Region ã¯æ—¥æœ¬ã«ã—ã¦ã¿ã¾ã—ãŸã€‚æ—¥æœ¬ã‚ã‚‹ã®ã™ã”ã„ã€‚
![](/images/2023-11-17-22-42-23.png)

SQL ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

![](/images/2023-11-17-22-22-45.png)

SQL å†…ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚‚æ›¸ã‹ã‚Œã¦ã¾ã™ãŒã€ä¸‹è¨˜ 3 ç‚¹ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚

1. pgvector extension ã‚’æœ‰åŠ¹åŒ–
2. documents ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
3. match_documents function ã‚’ä½œæˆ

SQL ã¯[Supabase | ğŸ¦œï¸ğŸ”— Langchain](https://js.langchain.com/docs/integrations/vectorstores/supabase)ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ã‚‚ã®ã‚’ãã®ã¾ã¾ä½¿ã„ã¾ã—ãŸã€‚

```sql
-- Enable the pgvector extension to work with embedding vectors
create extension vector;

-- Create a table to store your documents
create table documents (
  id bigserial primary key,
  content text, -- corresponds to Document.pageContent
  metadata jsonb, -- corresponds to Document.metadata
  embedding vector(1536) -- 1536 works for OpenAI embeddings, change if needed
);

-- Create a function to search for documents
create function match_documents (
  query_embedding vector(1536),
  match_count int DEFAULT null,
  filter jsonb DEFAULT '{}'
) returns table (
  id bigint,
  content text,
  metadata jsonb,
  embedding jsonb,
  similarity float
)
language plpgsql
as $$
#variable_conflict use_column
begin
  return query
  select
    id,
    content,
    metadata,
    (embedding::text)::jsonb as embedding,
    1 - (documents.embedding <=> query_embedding) as similarity
  from documents
  where metadata @> filter
  order by documents.embedding <=> query_embedding
  limit match_count;
end;
$$;
```

æ¬¡ã«ã€Supabase ã® Settings ã® API ã®ã¨ã“ã‚ã‹ã‚‰ã€URL ã¨ API key ã‚’å–å¾—ã—ã¾ã™ã€‚key ã¯ 2 ã¤ã‚ã‚‹ã†ã¡ã®ã€ä¸Šã«ã‚ã‚‹ public ã‚’ä½¿ã„ã¾ã™ã€‚

![](/images/2023-11-17-22-22-31.png)

`.env.local`ãƒ•ã‚¡ã‚¤ãƒ«ã«ä»¥ä¸‹ã®ã‚ˆã†ãªå½¢ã§ä¿å­˜ã—ã¾ã™ã€‚

```.env.local
OPENAI_API_KEY="hoge"
SUPABASE_PRIVATE_KEY="fuga"
SUPABASE_URL="https://piyo.supabase.co"
```

ã“ã‚Œã§ã€æº–å‚™ãŒã§ãã¾ã—ãŸï¼

# å‹•ä½œç¢ºèª

ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Ÿè¡Œã—ã¦ã€ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰æ–‡ç« ã‚’ Upload ã™ã‚‹ã¨ã†ã¾ãã„ãã¾ã—ãŸã€‚
![](/images/2023-11-17-23-01-19.png)

Supabase ã§ã¯ã€ã“ã‚“ãªæ„Ÿã˜ã«ãªã‚Šã¾ã—ãŸã€‚
![](/images/2023-11-17-22-25-56.png)

`metadata`ã¨ã—ã¦ã€æ–‡ç« ã®ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ã¨ã—ã¦ã€line number ãŒæ›¸ã‹ã‚Œã¦ãŸã‚Šã—ã¾ã™ã€‚vector ã¯ãã‚Œã£ã½ãé…åˆ—ã«ãªã£ã¦ã¾ã™ã€‚

è©¦ã—ã«ã€è³ªå•ã—ã¦ã¿ã‚‹ã¨ã€ãã‚Œã£ã½ãå›ç­”ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚å‚è€ƒã«ã—ã¦ã‚‹ã‚½ãƒ¼ã‚¹ã‚‚æ•™ãˆã¦ãã‚Œã¦ã„ã¾ã™ã€‚ã„ã„æ„Ÿã˜ï¼
![](/images/2023-11-17-22-21-33.png)

# ãŠã‚ã‚Šã«

ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€å‹•ã‹ã—ãªãŒã‚‰ LangChain.js ã‚’å­¦ã³ä¸­ã§ã—ãŸãŒã€Supabase ã‚‚è§¦ã‚‹ã“ã¨ãŒã§ãã¦é¢ç™½ã‹ã£ãŸã§ã™ã€‚
ãƒ™ã‚¯ã‚¿ãƒ¼ã‚¹ãƒˆã‚¢å°‚ç”¨ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒã‚ã‚‹ä¸­ã§ã€PostgreSQL ã‚’ãƒ™ã‚¯ã‚¿ãƒ¼ã‚¹ãƒˆã‚¢ã¨ã—ã¦ä½¿ã†ã®ã£ã¦æœ¬å½“ã«ã‚ã‚Šãªã‚“ã‚„ã‚ã‹ã¨æ€ã„ã¤ã¤ã€ã¨ã‚Šã‚ãˆãšå‹•ã„ãŸã®ã§ã‚ˆã—ã¨ã—ã¾ã—ãŸã€‚
ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ã‚³ãƒ¼ãƒ‰ã‚‚ã™ã”ãå‹‰å¼·ã«ãªã‚‹ã®ã§ã€èˆˆå‘³ã‚ã‚‹æ–¹ã„ã‚Œã°ãœã²å‹•ã‹ã—ãªãŒã‚‰ã¿ã¦ã¿ã‚‹ã¨è‰¯ã„ã¨æ€ã„ã¾ã™ã€‚
