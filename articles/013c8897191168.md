---
title: "OpenShift Container Platform registryã‚’ä½¿ã£ã¦ã¿ãŸ"
emoji: "ğŸ³"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [openshift, kubernetes, docker]
published: true
---

# ã¯ã˜ã‚ã«

OpenShift Container Platform registry ã¨ã‹ internal registry for OpenShift Container Platform ã¨ã‹å‘¼ã°ã‚Œã¦ã‚‹ OpenShift ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å…¥ã£ã¦ã‚‹ Image Registory ã‚’ä½¿ã†ã¨ãã«ãƒãƒã£ãŸã®ã§ã€ãã®ãƒ¡ãƒ¢ã€‚
OpenShift ä½¿ã£ã¦ã„ã¦ã€ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ OpenShift ã®ã‚¯ãƒ©ã‚¹ã‚¿ä¸Šã«ãŠããŸã„äººå‘ã‘ã®å†…å®¹ã€‚
ä¸‹è¨˜å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã ã¨ã€ã†ã¾ãã„ã‹ãªã‹ã£ãŸã®ã§ã€ãã‚Œãƒ—ãƒ©ã‚¹ã‚¢ãƒ«ãƒ•ã‚¡ã«ã¤ã„ã¦ã€‚
ä¸€éƒ¨ã€Mac å‘ã‘ã®å†…å®¹ã‚‚ã€‚

[Registry overview | Registry | OpenShift Container Platform 4.8](https://docs.openshift.com/container-platform/4.8/registry/index.html)

# ç’°å¢ƒ

ä»¥ä¸‹ã®é€šã‚Šã€‚
ï¼ˆMac ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ oc ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯é–¢ä¿‚ãªã„ã¨æ€ã†ï¼‰

OpenShift 4.8
Mac Monterey 12.5

```
$ oc version
Client Version: 4.9.15
Server Version: 4.8.46
Kubernetes Version: v1.21.11+6b3cbdd
```

# èƒŒæ™¯

ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ç½®ã„ã¨ãå ´æ‰€ã¨ã—ã¦ã€`Docker Hub`ã‚„`GitHub Packages Container registry`ãŒæœ‰åã ã‘ã©ã€OpenShift ä¸Šã«ã‚‚ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚’æ§‹ç¯‰ã§ãã‚‹ã‚‰ã—ã„ã€‚
ã©ã†ã‚‚ã€`OpenShift Container Platform registry`ã£ã¦å‘¼ã°ã‚Œã¦ã‚‹ã¿ãŸã„ã€‚the ãŒã¤ã„ã¦ã‚‹ã— registry ãŒå°æ–‡å­—ã‚„ã—ã€å›ºæœ‰åè©ã˜ã‚ƒãªã•ãã†ã‚„ã‘ã©ã€‚ã“ã†ã„ã†ã®ã‚“ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§æº–å‚™ã—ã¦ãã‚Œã¦ã‚‹ã®ãŒ OpenShift ã®è‰¯ã„ã¨ã“ã‚ãªã‚“ã‚„ã¨æ€ã†ã€‚

ã“ã“ã«è‰²ã€…è¼‰ã£ã¦ãã†ã€‚
[Registry OpenShift Container Platform 4.8 | Red Hat Customer Portal](https://access.redhat.com/documentation/en-us/openshift_container_platform/4.8/html/registry/index)

# ã—ãŸã“ã¨

ä¸‹è¨˜å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã€ã‚„ã‚Šæ–¹ãŒæ›¸ã‹ã‚Œã¦ã‚‹ã€‚ãŸã ã€ãã®ã¾ã¾ã˜ã‚ƒå‹•ã‹ãªã‹ã£ãŸã€‚
ä»¥ä¸‹ã€ã‚„ã£ãŸã“ã¨ã‚’é †ç•ªã«è¨˜è¼‰ã€‚

[Exposing the registry | Registry | OpenShift Container Platform 4.8](https://docs.openshift.com/container-platform/4.8/registry/securing-exposing-registry.html)

## OpenShift ã«ãƒ­ã‚°ã‚¤ãƒ³

ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å«ã‚“ã  login ã‚³ãƒãƒ³ãƒ‰ã‚’å–å¾—ã§ãã‚‹ã®ã§ã€ãã‚Œã‚’ã‚³ãƒ”ãƒšã—ã¦å®Ÿè¡Œã€‚

![](/images/013c8897191168/Overview.png)

```
 oc login --token=ã»ã’ --server=https://ãµãŒ
```

## config ã®ä¿®æ­£

ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ¬ã‚¸ã‚¹ãƒˆãƒªç”¨ã®è¨­å®šãƒªã‚½ãƒ¼ã‚¹ã‚’ä¿®æ­£ã™ã‚‹ã€‚

```
 oc patch configs.imageregistry.operator.openshift.io/cluster --patch '{"spec":{"defaultRoute":true}}' --type=merge
```

ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ã€ä¿®æ­£ã§ããŸã‹ç¢ºèªã§ãã‚‹ã€‚

```
oc describe configs.imageregistry.operator.openshift.io cluster
```

ãã‚Œã£ã½ã„æ„Ÿã˜ã«ãªã£ãŸã€‚

```
...

Spec:
  Default Route:       true

...
```

## ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ›ã‚¹ãƒˆåå–å¾—

æ¬¡ã«ã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ›ã‚¹ãƒˆåã‚’å–å¾—ã™ã‚‹ã€‚
ãã‚Œã£ã½ã„ route ãŒã‚ã‚‹ã‹ç¢ºèªã—ã¦ã¿ã‚‹ã€‚

```
oc get route -n openshift-image-registry
```

ç’°å¢ƒå¤‰æ•°ã«å…¥ã‚Œã¦ãŠãã€‚å¿…è¦ã«å¿œã˜ã¦ã€`.bashrc`ã¨ã‹ã«æ›¸ã„ã¦ãŠãã€‚

```
HOST=$(oc get route default-route -n openshift-image-registry --template='{{ .spec.host }}')
echo $HOST
```

## è¨¼æ˜æ›¸å–å¾—

æ¬¡ã«ã€è¨¼æ˜æ›¸ã‚’å–å¾—ã™ã‚‹ã€‚secret ã«ç™»éŒ²ã•ã‚Œã¦ã‚‹ã€‚ãªãœã‹ã€å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã ã¨å‹•ã‹ãªã„ã€‚

```
oc get secret -n openshift-ingress router-certs-default -o go-template='{{index .data "tls.crt"}}' | base64 -d | sudo tee /etc/pki/ca-trust/source/anchors/${HOST}.crt > /dev/null
```

ãã‚Œã£ã½ã„ã®ãŒãªã„ã‹æ¢ã—ã¦ã¿ã‚‹ã€‚

```
oc get secret -n openshift-ingress
```

`router-metrics-certs-default`ãŒãã‚Œã£ã½ã„ã®ã§ã€ç½®ãæ›ãˆã¦è©¦ã—ã¦ã¿ã‚‹ã€‚ãã†ã™ã‚‹ã¨å‹•ã„ãŸã€‚ã€`/etc/pki/ca-trust/source/anchors`ã‚’`mkdir -p`ã—ã¦ãŠãå¿…è¦ãŒã‚ã£ãŸã‹ã‚‚ã€‚

```
oc get secret -n openshift-ingress router-metrics-certs-default -o go-template='{{index .data "tls.crt"}}' | base64 -d | sudo tee /etc/pki/ca-trust/source/anchors/${HOST}.crt > /dev/null
```

## è¨¼æ˜æ›¸ã®ç™»éŒ²

æ¬¡ã«`sudo update-ca-trust enable`ã§è¨¼æ˜æ›¸ã‚’ç™»éŒ²ã™ã‚‹ã€‚ãŸã ã€Mac ã ã¨å‹•ã‹ãªã„ã®ã§ã€ä¸‹è¨˜ã‚µã‚¤ãƒˆã‚’å‚è€ƒã«ã€ç™»éŒ²ã™ã‚‹ã€‚`.crt`ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´æ‰€ã‚’ã“ã“ã§æŒ‡å®šã™ã‚‹ã®ã§ã€ã©ã“ã«ç½®ã„ã¦ã‚‚è‰¯ã‹ã£ãŸæ°—ãŒã™ã‚‹ã€‚

[ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆèªè¨¼å±€ã® CA è¨¼æ˜æ›¸ã‚’è¿½åŠ ã™ã‚‹(Windowsãƒ»Mac OS Xãƒ»CentOS 7ãƒ»Ubuntu Server16.04) | ä¿ºçš„å‚™å¿˜éŒ² ã€œãªã‚“ã‹ã„ã‚ã„ã‚ã€œ](https://orebibou.com/ja/home/201611/20161107_001/)

ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ã„ã‘ãŸã£ã½ã„ã€‚`security`ã‚³ãƒãƒ³ãƒ‰ã¯ä¸‹è¨˜å‚ç…§ã€‚
[security - cert - macOS - SS64.com](https://ss64.com/osx/security-cert.html)

```
sudo security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain /etc/pki/ca-trust/source/anchors/${HOST}.crt
```

## docker login ã—ã¦ push

å¾Œã¯ã€ã“ã‚“ãªæ„Ÿã˜ã§ docker login ã—ã¦ã€ã™ã§ã«ã‚ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã« tag ã‚’ã¤ã‘ã¦ã€pushã€‚
ãƒ›ã‚¹ãƒˆåã®å¾Œã«ã€namespace å…¥ã‚Œã¦ã€ãã®å¾Œã«

```
sudo docker login -u kubeadmin -p $(oc whoami -t) $HOST
docker tag fuga $HOST/hoge-namespace/fuga:latest
docker push $HOST/hoge-namespace/fuga:latest
```

docker tag ã¯ã“ã“ã‚‰å‚ç…§ã€‚
[docker tag â€” Docker-docs-ja 20.10 ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.docker.jp/engine/reference/commandline/tag.html)

push ã§ããŸã‹ã©ã†ã‹ã¨ã€ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‘ã‚¹ã¯ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèªã§ãã‚‹ã€‚

```
oc get imagestreams
```

# ãŠã‚ã‚Šã«

ãã“ãã“ãƒãƒã£ãŸã‘ã©ã€ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã£ã¦è‰¯ã‹ã£ãŸã€‚OpenShift ã®ç†è§£ã‚‚å¤šå°‘æ·±ã¾ã£ãŸæ°—ãŒã™ã‚‹ã€‚
